{"hash":"ecd927b9a305a9b4fcfe74e1d6ed2d4375589b41","data":{"markdownPage":{"id":"62ca8085ac028d79cee530aa8b3244cd","title":"AirBnB","description":"","path":"/example-scenario/accommodation-reservation/","timeToRead":22,"content":"<h1 id=\"airbnb\"><a href=\"#airbnb\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>AirBnB</h1>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119284989-fefe2580-bc7b-11eb-99ca-7a9e4183c16f.jpg\" alt=\"image\">\nsource: <a href=\"https://github.com/msa-ez/airbnb_project\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/msa-ez/airbnb_project</a></p>\n<h2>Accommodation reservation(AirBnB)</h2>\n<p>This example is configured to cover all stages of analysis/design/implementation/operation including MSA/DDD/Event Storming/EDA. It includes example answers to pass the checkpoints required for the development of cloud-native applications.</p>\n<ul>\n<li>checkpoint : <a href=\"https://workflowy.com/s/assessment-check-po/T5YrzcMewfo4J6LW\" target=\"_blank\" rel=\"noopener noreferrer\">https://workflowy.com/s/assessment-check-po/T5YrzcMewfo4J6LW</a></li>\n</ul>\n<h2 id=\"service-scenario\"><a href=\"#service-scenario\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>service scenario</h2>\n<p>Cover AirBnB</p>\n<p><strong>functional requirements</strong><br>\n1. Register/modify/delete the accommodation for the host to rent.<br>\n2. The customer selects and makes a reservation.<br>\n3. Payment is made at the same time as the reservation.<br>\n4. When a reservation is made, the reservation details (Message) are delivered.<br>\n5. The customer may cancel the reservation.<br>\n6. If the reservation is canceled, a cancellation message (Message) is delivered.<br>\n7. You can leave a review on the property.<br>\n8. You can check the overall accommodation information and reservation status on one screen. (viewpage)\n<br><br></p>\n<p><strong>Non-functional requirements</strong> <br>\n1. Transactions <br>\n2. Reservations without payment should not be established. (Sync call) <br>\n3. Failure isolation <br>\n4. Reservation should be available 24 hours a day, 365 days a year even if accommodation registration and message transmission functions are not performed Async (event-driven), Eventual Consistency<br><br>\n5. When the reservation system is overloaded, users are temporarily shut down. Inducing them to do it after a while without receiving it Circuit breaker, fallback<br><br>\n6. Performance <br>\n7. It should be possible to check all room information and reservation status at once (CQRS) <br>\n8. It should be possible to give a message whenever the reservation status changes Event driven)</p>\n<h2 id=\"checkpoint\"><a href=\"#checkpoint\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>CheckPoint</h2>\n<ul>\n<li>\n<p>analytical design</p>\n<ul>\n<li>\n<p>Event Storming:</p>\n<ul>\n<li>Do you properly understand the meaning of each sticker color object and properly reflect it in the design in connection with the hexagonal architecture?</li>\n<li>Is each domain event defined at a meaningful level?</li>\n<li>Aggregation: Are Commands and Events properly grouped into ACID transaction unit Aggregate?</li>\n<li>Are functional and non-functional requirements reflected without omission?</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>\n<p>Separation of subdomains, bounded contexts</p>\n<ul>\n<li>\n<p>Is the sub-domain or Bounded Context properly separated according to the team's KPIs, interests, and different distribution cycles, and is the rationality of the separation criteria sufficiently explained?</p>\n<ul>\n<li>Separation of at least 3 services</li>\n</ul>\n</li>\n<li>Polyglot design: Have you designed each microservice by adopting various technology stack and storage structures according to the implementation goals and functional characteristics of each microservice?</li>\n<li>In the service scenario, for the use case where the ACID transaction is critical, is the service not excessively and densely separated?</li>\n</ul>\n</li>\n<li>\n<p>Context Mapping / Event Driven Architecture</p>\n<ul>\n<li>Can you differentiate between task importance and hierarchy between domains? (Core, Supporting, General Domain)</li>\n<li>Can the request-response method and event-driven method be designed separately?</li>\n<li>Fault Isolation: Is it designed so that the existing service is not affected even if the supporting service is removed?</li>\n<li>Can it be designed (open architecture) so that the database of existing services is not affected when new services are added?</li>\n<li>Did you design the Correlation-key connection to connect the event and the policy properly?</li>\n</ul>\n</li>\n<li>\n<p>Hexagonal Architecture</p>\n<ul>\n<li>Did you draw the hexagonal architecture diagram according to the design result correctly?</li>\n</ul>\n</li>\n<li>\n<p>avatar</p>\n<ul>\n<li>\n<p>[DDD] Was the realization developed to be mapped according to the color of each sticker and the hexagonal architecture in the analysis stage?</p>\n<ul>\n<li>Have you developed a data access adapter through JPA by applying Entity Pattern and Repository Pattern?</li>\n<li>[Hexagonal Architecture] In addition to the REST inbound adapter, is it possible to adapt the existing implementation to a new protocol without damaging the domain model by adding an inbound adapter such as gRPC?</li>\n<li>Is the source code described using the ubiquitous language (terms used in the workplace) in the analysis stage?</li>\n</ul>\n</li>\n<li>\n<p>Implementation of service-oriented architecture of Request-Response method</p>\n<ul>\n<li>How did you find and call the target service in the Request-Response call between microservices? (Service Discovery, REST, FeignClient)</li>\n<li>Is it possible to isolate failures through circuit breakers?</li>\n</ul>\n</li>\n<li>\n<p>Implementing an event-driven architecture</p>\n<ul>\n<li>Are more than one service linked with PubSub using Kafka?</li>\n<li>Correlation-key: When each event (message) processes which policy, is the Correlation-key connection properly implemented to distinguish which event is connected to which event?</li>\n<li>Does the Message Consumer microservice receive and process existing events that were not received in the event of a failure?</li>\n<li>Scaling-out: Is it possible to receive events without duplicates when a replica of the Message Consumer microservice is added?</li>\n<li>CQRS: By implementing Materialized View, is it possible to configure the screen of my service and view it frequently without accessing the data source of other microservices (without Composite service or join SQL, etc.)?</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>\n<p>polyglot programming</p>\n<ul>\n<li>Are each microservices composed of one or more separate technology stacks?</li>\n<li>Did each microservice autonomously adopt its own storage structure and implement it by selecting its own storage type (RDB, NoSQL, File System, etc.)?</li>\n</ul>\n</li>\n<li>\n<p>API Gateway</p>\n<ul>\n<li>Can the point of entry of microservices be unified through API GW?</li>\n<li>Is it possible to secure microservices through gateway, authentication server (OAuth), and JWT token authentication?</li>\n</ul>\n</li>\n<li>\n<p>operation</p>\n<ul>\n<li>\n<p>SLA Compliance</p>\n<ul>\n<li>Self-Healing: Through the Liveness Probe, as the health status of any service continuously deteriorates, at what threshold can it be proven that the pod is regenerated?</li>\n<li>Can fault isolation and performance efficiency be improved through circuit breaker and ray limit?</li>\n<li>Is it possible to set up an autoscaler (HPA) for scalable operation?</li>\n<li>Monitoring, alerting:</li>\n</ul>\n</li>\n<li>\n<p>Nonstop Operation CI/CD (10)</p>\n<ul>\n<li>When the new version is fully serviceable through the setting of the Readiness Probe and rolling update, it is proved by siege that the service is converted to the new version of the service.</li>\n<li>Contract Test: Is it possible to prevent implementation errors or API contract violations in advance through automated boundary testing?</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"analysisdesign\"><a href=\"#analysisdesign\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Analysis/Design</h2>\n<h3>Horizontally-Aligned</h3>\n<p>  <img src=\"https://user-images.githubusercontent.com/77129832/119316165-96ca3680-bcb1-11eb-9a91-f2b627890bab.png\" alt=\"image\"></p>\n<h3>TO-BE Organization (Vertically-Aligned)</h3>\n<p>  <img src=\"https://user-images.githubusercontent.com/77129832/119315258-a09f6a00-bcb0-11eb-9940-c2a82f2f7d09.png\" alt=\"image\"></p>\n<h3>Event Storming Results</h3>\n<p><strong><a href=\"http://www.msaez.io/#/storming/QtpQtDiH1Je3wad2QxZUJVvnLzO2/6f36e16efdf8c872da3855fedf7f3ea9\" target=\"_blank\" rel=\"noopener noreferrer\">Eventstorming results modeled with MSAEz</a></strong></p>\n<p><strong>event derivation</strong>\n<img src=\"https://user-images.githubusercontent.com/15603058/119298548-337fda80-bc98-11eb-9f96-7d583d156fb9.png\" alt=\"image\"></p>\n<p><strong>Drop out of an ineligible event</strong>\n<img src=\"https://user-images.githubusercontent.com/15603058/119298594-4f837c00-bc98-11eb-9f67-ec2e882e1f33.png\" alt=\"image\"></p>\n<ul>\n<li>\n<p>Filtering out invalid domain events derived during the process</p>\n<ul>\n<li>Registration>RoomSearched, Reservation>RoomSelected: Excluded because it is a UI event and not a business event</li>\n</ul>\n</li>\n</ul>\n<p><strong>Easy to read by attaching actors and commands</strong>\n<img src=\"https://user-images.githubusercontent.com/15603058/119298993-113a8c80-bc99-11eb-9bae-4b911317d810.png\" alt=\"image\"></p>\n<p><strong>bind with aggregation</strong>\n<img src=\"https://user-images.githubusercontent.com/15603058/119299589-2663eb00-bc9a-11eb-83b9-de7f3efe7548.png\" alt=\"image\"></p>\n<ul>\n<li>Room, Reservation, Payment, and Review are grouped together as a unit in which transactions must be maintained by the commands and events associated with them.</li>\n</ul>\n<p><strong>Bind to Bounded Context</strong>\n<img src=\"https://user-images.githubusercontent.com/15603058/119300858-6c21b300-bc9c-11eb-9b3f-c85aff51658f.png\" alt=\"image\"></p>\n<ul>\n<li>\n<p>domain sequence separation </p>\n<ul>\n<li>Core Domain: reservation, room: It is an indispensable core service, and the annual Up-time SLA level is set at 99.999%, and the distribution cycle is less than once a week for reservation and less than once a month for room.</li>\n<li>Supporting Domain: message, viewpage: This is a service for competitiveness, and the SLA level is 60% or more per year uptime goal, and the distribution cycle is autonomous by each team, but the standard sprint cycle is one week, so it is based on at least once a week.</li>\n<li>General Domain: payment: It is more competitive to use a 3rd party external service as a payment service</li>\n</ul>\n</li>\n</ul>\n<p><strong>Attach the policy (parentheses are the subject of execution, and it does not matter if you attach the policy in the second step. The entire linkage is revealed at the beginning)</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119303664-1b608900-bca1-11eb-8667-7545f32c9fb9.png\" alt=\"image\"></p>\n<p><strong>Policy movement and context mapping (dashed lines are Pub/Sub, solid lines are Req/Resp)</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119304604-73e45600-bca2-11eb-8f1d-607006919fab.png\" alt=\"image\"></p>\n<p><strong>Completed first model</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119305002-0edd3000-bca3-11eb-9cc0-1ba8b17f2432.png\" alt=\"image\"></p>\n<ul>\n<li>Add View Model</li>\n</ul>\n<p><strong>Verification that functional/non-functional requirements for the first complete version are</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119306321-f110ca80-bca4-11eb-804c-a965220bad61.png\" alt=\"image\"></p>\n<ul>\n<li>Register/modify/delete accommodation for the host to rent (ok)</li>\n<li>The customer selects and makes a reservation (ok)</li>\n<li>Payment is made at the same time as the reservation. (ok)</li>\n<li>When a reservation is made, the reservation details (Message) are delivered.(?)</li>\n<li>The customer can cancel the reservation (ok).</li>\n<li>If the reservation is canceled, a cancellation message is sent.(?)</li>\n<li>You can leave a review on the property (ok).</li>\n<li>You can check the overall accommodation information and reservation status on one screen. (Add View-green Sticker is ok)\n</li>\n</ul>\n<p><strong>Modify the model</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119307481-b740c380-bca6-11eb-9ee6-fda446e299bc.png\" alt=\"image\"></p>\n<ul>\n<li>The modified model covers all requirements.</li>\n</ul>\n<p><strong>Verification of non-functional requirements</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/15603058/119311800-79df3480-bcac-11eb-9c1b-0382d981f92f.png\" alt=\"image\"></p>\n<ul>\n<li>Transaction processing for scenarios that cross microservices</li>\n<li>Payment processing at the time of customer reservation: ACID transaction is applied by deciding that reservations that have not been paid will never be accepted. When booking is completed, check the room status in advance and process the request-response method for payment processing</li>\n<li>Host connection and reservation processing when payment is completed: Since the room microservice has a separate distribution cycle in the process of transferring the reservation request from reservation to the room microservice, the transaction is processed in the eventual consistency method.</li>\n<li>All other inter-microservice transactions: For all events such as reservation status and post-processing, it is judged that the timing of data consistency is not critical in most cases, so Eventual Consistency is adopted as the default.</li>\n</ul>\n<p><strong>Hexagonal Architecture Diagram Derivation</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/80744273/119319091-fc6bf200-bcb4-11eb-9dac-0995c84a82e0.png\" alt=\"image\"></p>\n<ul>\n<li>Distinguish between inbound adapters and outbound adapters by referring to Chris Richardson, MSA Patterns</li>\n<li>Distinguish between PubSub and Req/Resp in the call relationship</li>\n<li>Separation of sub-domains and bounded contexts: Each team’s KPIs share their interest implementation stories as follows</li>\n</ul>\n<h2 id=\"avatar\"><a href=\"#avatar\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>avatar</h2>\n<p>According to the hexagonal architecture derived from the analysis/design phase, microservices represented by each BC were implemented with Spring Boot. The method to run each implemented service locally is as follows (each port number is 8081 ~ 808n)</p>\n<pre class=\"language-text\"><code class=\"language-text\">mvn spring-boot:run</code></pre>\n<h3 id=\"·-cqrs\"><a href=\"#%C2%B7-cqrs\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· CQRS</h3>\n<p>CQRS was implemented so that customers can inquire about total status such as availability of rooms, reviews and reservations/payments.</p>\n<ul>\n<li>Performance issues can be prevented in advance by integrating individual aggregate status for room, review, reservation, and payment.</li>\n<li>Asynchronously processed and issued event-based Kafka is received/processed and managed in a separate table</li>\n<li>Table modeling (ROOMVIEW)</li>\n</ul>\n<p>  <img src=\"https://user-images.githubusercontent.com/77129832/119319352-4b198c00-bcb5-11eb-93bc-ff0657feeb9f.png\" alt=\"image\"></p>\n<ul>\n<li>Implemented through viewpage MSA ViewHandler (when “RoomRegistered” event occurs, it is saved in a separate Roomview table based on Pub/Sub)\n<img src=\"https://user-images.githubusercontent.com/77129832/119321162-4d7ce580-bcb7-11eb-9030-29ee6272c40d.png\" alt=\"image\">\n<img src=\"https://user-images.githubusercontent.com/31723044/119350185-fccab400-bcd9-11eb-8269-61868de41cc7.png\" alt=\"image\"></li>\n<li>In fact, if you look up the view page, you can see information such as overall reservation status, payment status, and number of reviews for all rooms.\n<img src=\"https://user-images.githubusercontent.com/31723044/119357063-1b34ad80-bce2-11eb-94fb-a587261ab56f.png\" alt=\"image\"></li>\n</ul>\n<h3 id=\"·-api-gateway\"><a href=\"#%C2%B7-api-gateway\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· API Gateway</h3>\n<ol>\n<li>After adding the gateway Spring Boot App, add routes for each microservice in application.yaml and set the gateway server port to 8080.</li>\n</ol>\n<ul>\n<li>application.yaml example</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">spring:\n  profiles: docker\n  cloud:\n    gateway:\n      routes:\n        - id: payment\n          uri: http://payment:8080\n          predicates:\n            - Path=/payments/** \n        - id: room\n          uri: http://room:8080\n          predicates:\n            - Path=/rooms/**, /reviews/**, /check/**\n        - id: reservation\n          uri: http://reservation:8080\n          predicates:\n            - Path=/reservations/**\n        - id: message\n          uri: http://message:8080\n          predicates:\n            - Path=/messages/** \n        - id: viewpage\n          uri: http://viewpage:8080\n          predicates:\n            - Path= /roomviews/**\n      globalcors:\n        corsConfigurations:\n          &#39;[/**]&#39;:\n            allowedOrigins:\n              - &quot;*&quot;\n            allowedMethods:\n              - &quot;*&quot;\n            allowedHeaders:\n              - &quot;*&quot;\n            allowCredentials: true\n\nserver:\n  port: 8080            </code></pre>\n<ol start=\"2\">\n<li>Write Deployment.yaml for Kubernetes and create Deploy on Kubernetes</li>\n</ol>\n<ul>\n<li>Deployment.yaml example</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: gateway\n  namespace: airbnb\n  labels:\n    app: gateway\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: gateway\n  template:\n    metadata:\n      labels:\n        app: gateway\n    spec:\n      containers:\n        - name: gateway\n          image: 247785678011.dkr.ecr.us-east-2.amazonaws.com/gateway:1.0\n          ports:\n            - containerPort: 8080</code></pre>\n<ul>\n<li>Create a Deploy</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f deployment.yaml</code></pre>\n<ul>\n<li>Deploy created in Kubernetes. Confirm\n</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/80744273/119321943-1d821200-bcb8-11eb-98d7-bf8def9ebf80.png\" alt=\"image\"></p>\n<ol start=\"3\">\n<li>Create a Service.yaml for Kubernetes and create a Service/LoadBalancer in Kubernetes to check the Gateway endpoint</li>\n</ol>\n<ul>\n<li>Service.yaml example</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">apiVersion: v1\n  kind: Service\n  metadata:\n    name: gateway\n    namespace: airbnb\n    labels:\n      app: gateway\n  spec:\n    ports:\n      - port: 8080\n        targetPort: 8080\n    selector:\n      app: gateway\n    type:\n      LoadBalancer           </code></pre>\n<ul>\n<li>Create Service</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f service.yaml            </code></pre>\n<ul>\n<li>Check API Gateway endpoint </li>\n<li>Check Service and endpoint </li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get svc -n airbnb           </code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/80744273/119318358-2a046b80-bcb4-11eb-9d46-ef2d498c2cff.png\" alt=\"image\"></p>\n<h2 id=\"correlation\"><a href=\"#correlation\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Correlation</h2>\n<p>In the Airbnb project, the Correlation-key implementation for distinguishing the type of processing in PolicyHandler is passed as a variable in the event class to accurately implement the related processing between services.</p>\n<p>Take a look at the implementation example below</p>\n<p>When you make a reservation, the status of services such as room and payment are appropriately changed at the same time. You can check that the data such as the state value is changed to the appropriate state.</p>\n<p>reservation registration\n<img src=\"https://user-images.githubusercontent.com/31723044/119320227-54572880-bcb6-11eb-973b-a9a5cd1f7e21.png\" alt=\"image\">\nAfter booking - room condition\n<img src=\"https://user-images.githubusercontent.com/31723044/119320300-689b2580-bcb6-11eb-933e-98be5aadca61.png\" alt=\"image\">\nAfter reservation - reservation status\n<img src=\"https://user-images.githubusercontent.com/31723044/119320390-810b4000-bcb6-11eb-8c62-48f6765c570a.png\" alt=\"image\">\nAfter booking - payment status\n<img src=\"https://user-images.githubusercontent.com/31723044/119320524-a39d5900-bcb6-11eb-864b-173711eb9e94.png\" alt=\"image\">\ncancel reservation\n<img src=\"https://user-images.githubusercontent.com/31723044/119320595-b6b02900-bcb6-11eb-8d8d-0d5c59603c72.png\" alt=\"image\">\nAfter Cancellation - Room Status\n<img src=\"https://user-images.githubusercontent.com/31723044/119320680-ccbde980-bcb6-11eb-8b7c-66315329aafe.png\" alt=\"image\">\nAfter Cancellation - Reservation Status\n<img src=\"https://user-images.githubusercontent.com/31723044/119320747-dcd5c900-bcb6-11eb-9c44-fd3781c7c55f.png\" alt=\"image\">\nAfter Cancellation - Payment Status\n<img src=\"https://user-images.githubusercontent.com/31723044/119320806-ee1ed580-bcb6-11eb-8ccf-8c81385cc8ba.png\" alt=\"image\"></p>\n<h3 id=\"·-synchronous-call-sync-and-fallback-handling\"><a href=\"#%C2%B7-synchronous-call-sync-and-fallback-handling\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· Synchronous call (Sync) and Fallback handling</h3>\n<p>As one of the conditions in the analysis stage, it was decided to process the reservation availability status check call between rooms when making a reservation as a transaction that maintains synchronous consistency. The calling protocol allows the REST service already exposed by the Rest Repository to be called using FeignClient. Also, the reservation -> payment service was decided to be processed synchronously.</p>\n<ul>\n<li>Implement the service proxy interface (Proxy) using stub and (FeignClient) to call the room and payment service</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># PaymentService.java\n\npackage airbnb.external;\n\n&lt;omit the import statement&gt;\n\n@FeignClient(name=&quot;Payment&quot;, url=&quot;${prop.room.url}&quot;)\npublic interface PaymentService {\n\n    @RequestMapping(method= RequestMethod.POST, path=&quot;/payments&quot;)\n    public void approvePayment(@RequestBody Payment payment);\n\n}\n\n# RoomService.java\n\npackage airbnb.external;\n\n&lt;omit the import statement&gt;\n\n@FeignClient(name=&quot;Room&quot;, url=&quot;${prop.room.url}&quot;)\npublic interface RoomService {\n\n    @RequestMapping(method= RequestMethod.GET, path=&quot;/check/chkAndReqReserve&quot;)\n    public boolean chkAndReqReserve(@RequestParam(&quot;roomId&quot;) long roomId);\n\n}</code></pre>\n<ul>\n<li>Immediately after receiving the reservation request (@PostPersist), check the availability and process the payment request synchronously (Sync)</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># Reservation.java (Entity)\n\n    @PostPersist\n    public void onPostPersist(){\n\n        ////////////////////////////////\n        // When INSERTed into RESERVATION\n        ////////////////////////////////\n\n        ////////////////////////////////////\n        // When a reservation request (reqReserve) is received\n        ////////////////////////////////////\n\n        // Check if the ROOM is available\n        boolean result = ReservationApplication.applicationContext.getBean(airbnb.external.RoomService.class)\n                        .chkAndReqReserve(this.getRoomId());\n        System.out.println(&quot;######## Check Result : &quot; + result);\n\n        if(result) { \n\n            // If reservation is available\n\n            //////////////////////////////\n            // PAYMENT payment in progress (POST method) - SYNC call\n            //////////////////////////////\n            airbnb.external.Payment payment = new airbnb.external.Payment();\n            payment.setRsvId(this.getRsvId());\n            payment.setRoomId(this.getRoomId());\n            payment.setStatus(&quot;paid&quot;);\n            ReservationApplication.applicationContext.getBean(airbnb.external.PaymentService.class)\n                .approvePayment(payment);\n\n            /////////////////////////////////////\n            // Event publication --&gt; ReservationCreated\n            /////////////////////////////////////\n            ReservationCreated reservationCreated = new ReservationCreated();\n            BeanUtils.copyProperties(this, reservationCreated);\n            reservationCreated.publishAfterCommit();\n        }\n    }</code></pre>\n<ul>\n<li>Confirm that synchronous calls result in time coupling with the time of the call, and that orders cannot be taken if the payment system fails:</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># Pause the pay service temporarily (ctrl+c)\n\n# Reservation request\nhttp POST http://localhost:8088/reservations roomId=1 status=reqReserve   #Fail\n\n# Restart payment service\ncd payment\nmvn spring-boot:run\n\n# Reservation request\nhttp POST http://localhost:8088/reservations roomId=1 status=reqReserve   #Success</code></pre>\n<ul>\n<li>Also, in case of excessive request, service failure can occur like dominoes. (Circuit breaker and fallback processing will be explained in the operation phase.)</li>\n</ul>\n<h3 id=\"·-asynchronous-invocation--temporal-decoupling--failure-isolation--eventual-consistency-test\"><a href=\"#%C2%B7-asynchronous-invocation--temporal-decoupling--failure-isolation--eventual-consistency-test\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· Asynchronous Invocation / Temporal Decoupling / Failure Isolation / Eventual Consistency Test</h3>\n<p>After payment is made, the status of the accommodation system is updated, the status of the reservation system is updated, and communication with the system to which reservation and cancellation messages are transmitted is handled asynchronously.</p>\n<ul>\n<li>For this, when the payment is approved, an event indicating that the payment has been approved is transmitted to Kafka. (Publish)</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># Payment.java\n\npackage airbnb;\n\nimport javax.persistence.*;\nimport org.springframework.beans.BeanUtils;\n\n@Entity\n@Table(name=&quot;Payment_table&quot;)\npublic class Payment {\n\n    ....\n\n    @PostPersist\n    public void onPostPersist(){\n        ////////////////////////////\n        // If payment is approved\n        ////////////////////////////\n\n        // Event publication -&gt; PaymentApproved\n        PaymentApproved paymentApproved = new PaymentApproved();\n        BeanUtils.copyProperties(this, paymentApproved);\n        paymentApproved.publishAfterCommit();\n    }\n    \n    ....\n}</code></pre>\n<ul>\n<li>Reservation system implements PolicyHandler to receive payment approval event and handle its own policy:</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># Reservation.java\n\npackage airbnb;\n\n    @PostUpdate\n    public void onPostUpdate(){\n    \n        ....\n\n        if(this.getStatus().equals(&quot;reserved&quot;)) {\n\n            ////////////////////\n            // When the reservation is confirmed\n            ////////////////////\n\n            // event occurs --&gt; ReservationConfirmed\n            ReservationConfirmed reservationConfirmed = new ReservationConfirmed();\n            BeanUtils.copyProperties(this, reservationConfirmed);\n            reservationConfirmed.publishAfterCommit();\n        }\n        \n        ....\n        \n    }</code></pre>\n<p>Other message services are completely separated from reservation/payment and are processed according to event reception, so there is no problem in receiving reservations even if the message service is temporarily down due to maintenance.</p>\n<pre class=\"language-text\"><code class=\"language-text\"># Pause message service (ctrl+c)\n\n# Reservation request\nhttp POST http://localhost:8088/reservations roomId=1 status=reqReserve   #Success\n\n# Check your reservation status\nhttp GET localhost:8088/reservations    #Regardless of the message service, the reservation status is normal</code></pre>\n<h2 id=\"operation\"><a href=\"#operation\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>operation</h2>\n<h3 id=\"·-cicd-settings\"><a href=\"#%C2%B7-cicd-settings\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· CI/CD settings</h3>\n<p>Each implementation was configured in their own source repository, and the CI/CD used was AWS codebuild using buildspec.yml.</p>\n<ul>\n<li>Create a CodeBuild project and set the AWS_ACCOUNT_ID, KUBE_URL, and KUBE_TOKEN environment variables.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">SA creation\nkubectl apply -f eks-admin-service-account.yml</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119293259-ff52ec80-bc8c-11eb-8671-b9a226811762.PNG\" alt=\"codebuild(sa)\"></p>\n<pre class=\"language-text\"><code class=\"language-text\">Create Role\nkubectl apply -f eks-admin-cluster-role-binding.yml</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119293300-1abdf780-bc8d-11eb-9b07-ad173237efb1.PNG\" alt=\"codebuild(role)\"></p>\n<pre class=\"language-text\"><code class=\"language-text\">Token confirmation\nkubectl -n kube-system get secret\nkubectl -n kube-system describe secret eks-admin-token-rjpmq</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119293511-84d69c80-bc8d-11eb-99c7-e8929e6a41e4.PNG\" alt=\"codebuild(token)\"></p>\n<pre class=\"language-text\"><code class=\"language-text\">buildspec.yml file \nSet to use the yml file of the microservice room</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119283849-30292680-bc79-11eb-9f86-cbb715e74846.PNG\" alt=\"codebuild(buildspec)\"></p>\n<ul>\n<li>run codebuild</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">codebuild project and build history</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119283851-315a5380-bc79-11eb-9b2a-b4522d22d009.PNG\" alt=\"codebuild(프로젝트)\">\n<img src=\"https://user-images.githubusercontent.com/38099203/119283850-30c1bd00-bc79-11eb-9547-1ff1f62e48a4.PNG\" alt=\"codebuild(로그)\"></p>\n<ul>\n<li>codebuild build history (Message service details)</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/31723044/119385500-2b0fba00-bd01-11eb-861b-cc31910ff945.png\" alt=\"image\"></p>\n<ul>\n<li>codebuild build history (view full history)</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/31723044/119385401-087da100-bd01-11eb-8b69-ce222e6bb71e.png\" alt=\"image\"></p>\n<h3 id=\"·-synchronous-call--circuit-breaking--fault-isolation\"><a href=\"#%C2%B7-synchronous-call--circuit-breaking--fault-isolation\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· Synchronous Call / Circuit Breaking / Fault Isolation</h3>\n<ul>\n<li>Circuit Breaking Framework of choice: implemented using istio</li>\n</ul>\n<p>The scenario is implemented by linking the connection at reservation--> room with RESTful Request/Response, and when the reservation request is excessive, fault isolation through CB.</p>\n<ul>\n<li>Create a DestinationRule to allow circuit break to occur. Set a minimum connection pool.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># destination-rule.yml\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: dr-room\n  namespace: airbnb\nspec:\n  host: room\n  trafficPolicy:\n    connectionPool:\n      http:\n        http1MaxPendingRequests: 1\n        maxRequestsPerConnection: 1\n#    outlierDetection:\n#      interval: 1s\n#      consecutiveErrors: 1\n#      baseEjectionTime: 10s\n#      maxEjectionPercent: 100</code></pre>\n<ul>\n<li>Activate istio-injection and check the room pod container</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get ns -L istio-injection\nkubectl label namespace airbnb istio-injection=enabled </code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119295450-d6812600-bc91-11eb-8aad-46eeac968a41.PNG\" alt=\"Circuit Breaker(istio-enjection)\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119295568-0cbea580-bc92-11eb-9d2b-8580f3576b47.PNG\" alt=\"Circuit Breaker(pod)\"></p>\n<ul>\n<li>Check circuit breaker operation with load tester siege tool:</li>\n</ul>\n<p>run siege</p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl run siege --image=apexacme/siege-nginx -n airbnb\nkubectl exec -it siege -c siege -n airbnb -- /bin/bash</code></pre>\n<ul>\n<li>When load is created with concurrent user 1, everything is normal.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">siege -c1 -t10S -v --content-type &quot;application/json&quot; &#39;http://room:8080/rooms POST {&quot;desc&quot;: &quot;Beautiful House3&quot;}&#39;\n\n** SIEGE 4.0.4\n** Preparing 1 concurrent users for battle.\nThe server is now under siege...\nHTTP/1.1 201     0.49 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.05 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     254 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     256 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     256 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     256 bytes ==&gt; POST http://room:8080/rooms</code></pre>\n<ul>\n<li>168 503 errors occurred when creating a load with simultaneous user 2</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">siege -c2 -t10S -v --content-type &quot;application/json&quot; &#39;http://room:8080/rooms POST {&quot;desc&quot;: &quot;Beautiful House3&quot;}&#39;\n\n** SIEGE 4.0.4\n** Preparing 2 concurrent users for battle.\nThe server is now under siege...\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 503     0.10 secs:      81 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.04 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.05 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.22 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.08 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.07 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 503     0.01 secs:      81 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 503     0.01 secs:      81 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     258 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 503     0.00 secs:      81 bytes ==&gt; POST http://room:8080/rooms\n\nLifting the server siege...\nTransactions:                   1904 hits\nAvailability:                  91.89 %\nElapsed time:                   9.89 secs\nData transferred:               0.48 MB\nResponse time:                  0.01 secs\nTransaction rate:             192.52 trans/sec\nThroughput:                     0.05 MB/sec\nConcurrency:                    1.98\nSuccessful transactions:        1904\nFailed transactions:             168\nLongest transaction:            0.03\nShortest transaction:           0.00</code></pre>\n<ul>\n<li>check circuit break on kiali screen</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119298194-7f7e4f80-bc97-11eb-8447-678eece29e5c.PNG\" alt=\"Circuit Breaker(kiali)\"></p>\n<ul>\n<li>Check the load again with the minimum connection pool again</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">** SIEGE 4.0.4\n** Preparing 1 concurrent users for battle.\nThe server is now under siege...\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.00 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.00 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.00 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\n\n:\n:\n\nLifting the server siege...\nTransactions:                   1139 hits\nAvailability:                 100.00 %\nElapsed time:                   9.19 secs\nData transferred:               0.28 MB\nResponse time:                  0.01 secs\nTransaction rate:             123.94 trans/sec\nThroughput:                     0.03 MB/sec\nConcurrency:                    0.98\nSuccessful transactions:        1139\nFailed transactions:               0\nLongest transaction:            0.04\nShortest transaction:           0.00</code></pre>\n<ul>\n<li>The operating system does not die and continuously shows that the circuit is properly opened and closed by CB to protect the resource. Post-processing to expand the system through virtualhost configuration and dynamic scale out (automatic addition of replica, HPA) is required.</li>\n</ul>\n<p><strong>Auto Scale Out Previously</strong>\nCB enabled stable operation of the system, but it did not accept 100% of the user's request, so we want to apply an automated extension function as a complement to this.</p>\n<ul>\n<li>Add resources configuration to room deployment.yml file\n<img src=\"https://user-images.githubusercontent.com/38099203/119283787-0a038680-bc79-11eb-8d9b-d8aed8847fef.PNG\" alt=\"Autoscale (HPA)\"></li>\n<li>Configure HPA to dynamically grow replicas for the room service. The setting increases the number of replicas to 10 when CPU usage exceeds 50%:</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl autoscale deployment room -n airbnb --cpu-percent=50 --min=1 --max=10</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119299474-ec92e480-bc99-11eb-9bc3-8c5246b02783.PNG\" alt=\"Autoscale (HPA)(kubectl autoscale 명령어)\"></p>\n<ul>\n<li>Load 100 concurrent users for 1 minute.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">siege -c100 -t60S -v --content-type &quot;application/json&quot; &#39;http://room:8080/rooms POST {&quot;desc&quot;: &quot;Beautiful House3&quot;}&#39;</code></pre>\n<ul>\n<li>Monitor how the autoscale is going</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get deploy room -w -n airbnb </code></pre>\n<ul>\n<li>After some time (about 30 seconds) you can see the scale out occurs:\n<img src=\"https://user-images.githubusercontent.com/38099203/119299704-6a56f000-bc9a-11eb-9ba8-55e5978f3739.PNG\" alt=\"Autoscale (HPA)(모니터링)\"></li>\n<li>If you look at the log of siege, you can see that the overall success rate has increased.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">Lifting the server siege...\nTransactions:                  15615 hits\nAvailability:                 100.00 %\nElapsed time:                  59.44 secs\nData transferred:               3.90 MB\nResponse time:                  0.32 secs\nTransaction rate:             262.70 trans/sec\nThroughput:                     0.07 MB/sec\nConcurrency:                   85.04\nSuccessful transactions:       15675\nFailed transactions:               0\nLongest transaction:            2.55\nShortest transaction:           0.01</code></pre>\n<h3 id=\"·-uninterrupted-redistribution\"><a href=\"#%C2%B7-uninterrupted-redistribution\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>· Uninterrupted redistribution</h3>\n<ul>\n<li>First, remove Autoscaler or CB settings to check whether non-stop redistribution is 100%.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl delete destinationrules dr-room -n airbnb\nkubectl label namespace airbnb istio-injection-\nkubectl delete hpa room -n airbnb</code></pre>\n<ul>\n<li>Monitoring the workload right before deployment with seige.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">siege -c100 -t60S -r10 -v --content-type &quot;application/json&quot; &#39;http://room:8080/rooms POST {&quot;desc&quot;: &quot;Beautiful House3&quot;}&#39;\n\n** SIEGE 4.0.4\n** Preparing 1 concurrent users for battle.\nThe server is now under siege...\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.03 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.00 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.02 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms\nHTTP/1.1 201     0.01 secs:     260 bytes ==&gt; POST http://room:8080/rooms</code></pre>\n<ul>\n<li>Start deploying to a new version</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl set image ...</code></pre>\n<ul>\n<li>Go to seige's screen and check if Availability has dropped below 100%</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">siege -c100 -t60S -r10 -v --content-type &quot;application/json&quot; &#39;http://room:8080/rooms POST {&quot;desc&quot;: &quot;Beautiful House3&quot;}&#39;\n\n\nTransactions:                   7732 hits\nAvailability:                  87.32 %\nElapsed time:                  17.12 secs\nData transferred:               1.93 MB\nResponse time:                  0.18 secs\nTransaction rate:             451.64 trans/sec\nThroughput:                     0.11 MB/sec\nConcurrency:                   81.21\nSuccessful transactions:        7732\nFailed transactions:            1123\nLongest transaction:            0.94\nShortest transaction:           0.00</code></pre>\n<ul>\n<li>During the distribution period, it was confirmed that the availability fell from 100% to 87%. The reason is that Kubernetes recognized the newly uploaded service as a READY state and proceeded to introduce the service. To prevent this, readiness probe is set.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\"># Configure readiness probe in deployment.yaml:</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119301424-71333200-bc9d-11eb-9f75-f8c98fce70a3.PNG\" alt=\"probe설정\"></p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f kubernetes/deployment.yml</code></pre>\n<ul>\n<li>Check Availability after redeploying with the same scenario:</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">Lifting the server siege...\nTransactions:                  27657 hits\nAvailability:                 100.00 %\nElapsed time:                  59.41 secs\nData transferred:               6.91 MB\nResponse time:                  0.21 secs\nTransaction rate:             465.53 trans/sec\nThroughput:                     0.12 MB/sec\nConcurrency:                   99.60\nSuccessful transactions:       27657\nFailed transactions:               0\nLongest transaction:            1.20\nShortest transaction:           0.00</code></pre>\n<p>Uninterrupted redistribution is confirmed to be successful because availability does not change during the distribution period.</p>\n<h2 id=\"self-healing-liveness-probe\"><a href=\"#self-healing-liveness-probe\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Self-healing (Liveness Probe)</h2>\n<ul>\n<li>Edit room deployment.yml file</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">After running the container, create a /tmp/healthy file\nDelete after 90 seconds\nMake livenessProbe validate with &#39;cat /tmp/healthy&#39;</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119318677-8ff0f300-bcb4-11eb-950a-e3c15feed325.PNG\" alt=\"deployment yml tmp healthy\"></p>\n<ul>\n<li>Check by running kubectl describe pod room -n airbnb</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">After 90 seconds of running the container, the driver is normal, but after that, the /tmp/healthy file is deleted and livenessProbe returns a failure.\nIf the pod is in a normal state, enter the pod and create a /tmp/healthy file to maintain the normal state.</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119318781-a9923a80-bcb4-11eb-9783-65051ec0d6e8.PNG\" alt=\"get pod tmp healthy\">\n<img src=\"https://user-images.githubusercontent.com/38099203/119319050-f118c680-bcb4-11eb-8bca-aa135c1e067e.PNG\" alt=\"touch tmp healthy\"></p>\n<h2 id=\"config-map-persistence-volume\"><a href=\"#config-map-persistence-volume\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Config Map/ Persistence Volume</h2>\n<ul>\n<li>Persistence Volume</li>\n</ul>\n<p>1: Create EFS</p>\n<pre class=\"language-text\"><code class=\"language-text\">You must select a VPC for your cluster when creating EFS</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119364089-85048580-bce9-11eb-8001-1c20a93b8e36.PNG\" alt=\"You must choose a VPC for your cluster\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119343415-60041880-bcd1-11eb-9c25-1695c858f6aa.PNG\" alt=\"Create EFS\"></p>\n<ol start=\"2\">\n<li>EFS account creation and ROLE binding</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f efs-sa.yml\n\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: efs-provisioner\n  namespace: airbnb\n\n\nkubectl get ServiceAccount efs-provisioner -n airbnb\nNAME              SECRETS   AGE\nefs-provisioner   1         9m1s  \n  \n  \n  \nkubectl apply -f efs-rbac.yaml\n\nYou must edit the namespace\n\n  \napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: efs-provisioner-runner\n  namespace: airbnb\nrules:\n  - apiGroups: [&quot;&quot;]\n    resources: [&quot;persistentvolumes&quot;]\n    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]\n  - apiGroups: [&quot;&quot;]\n    resources: [&quot;persistentvolumeclaims&quot;]\n    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]\n  - apiGroups: [&quot;storage.k8s.io&quot;]\n    resources: [&quot;storageclasses&quot;]\n    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]\n  - apiGroups: [&quot;&quot;]\n    resources: [&quot;events&quot;]\n    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: run-efs-provisioner\n  namespace: airbnb\nsubjects:\n  - kind: ServiceAccount\n    name: efs-provisioner\n     # replace with namespace where provisioner is deployed\n    namespace: airbnb\nroleRef:\n  kind: ClusterRole\n  name: efs-provisioner-runner\n  apiGroup: rbac.authorization.k8s.io\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: leader-locking-efs-provisioner\n  namespace: airbnb\nrules:\n  - apiGroups: [&quot;&quot;]\n    resources: [&quot;endpoints&quot;]\n    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: leader-locking-efs-provisioner\n  namespace: airbnb\nsubjects:\n  - kind: ServiceAccount\n    name: efs-provisioner\n    # replace with namespace where provisioner is deployed\n    namespace: airbnb\nroleRef:\n  kind: Role\n  name: leader-locking-efs-provisioner\n  apiGroup: rbac.authorization.k8s.io</code></pre>\n<ol start=\"3\">\n<li>Deploy EFS Provisioner</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f efs-provisioner-deploy.yml\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: efs-provisioner\n  namespace: airbnb\nspec:\n  replicas: 1\n  strategy:\n    type: Recreate\n  selector:\n    matchLabels:\n      app: efs-provisioner\n  template:\n    metadata:\n      labels:\n        app: efs-provisioner\n    spec:\n      serviceAccount: efs-provisioner\n      containers:\n        - name: efs-provisioner\n          image: quay.io/external_storage/efs-provisioner:latest\n          env:\n            - name: FILE_SYSTEM_ID\n              value: fs-562f9c36\n            - name: AWS_REGION\n              value: ap-northeast-2\n            - name: PROVISIONER_NAME\n              value: my-aws.com/aws-efs\n          volumeMounts:\n            - name: pv-volume\n              mountPath: /persistentvolumes\n      volumes:\n        - name: pv-volume\n          nfs:\n            server: fs-562f9c36.efs.ap-northeast-2.amazonaws.com\n            path: /\n\n\nkubectl get Deployment efs-provisioner -n airbnb\nNAME              READY   UP-TO-DATE   AVAILABLE   AGE\nefs-provisioner   1/1     1            1           11m</code></pre>\n<ol start=\"4\">\n<li>Register the installed provisioner to storageclass</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f efs-storageclass.yml\n\n\nkind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: aws-efs\n  namespace: airbnb\nprovisioner: my-aws.com/aws-efs\n\n\nkubectl get sc aws-efs -n airbnb\nNAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE\naws-efs         my-aws.com/aws-efs      Delete          Immediate              false                  4s</code></pre>\n<ol start=\"5\">\n<li>Create a PersistentVolumeClaim (PVC)</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f volume-pvc.yml\n\n\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: aws-efs\n  namespace: airbnb\n  labels:\n    app: test-pvc\nspec:\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 6Ki\n  storageClassName: aws-efs\n  \n  \nkubectl get pvc aws-efs -n airbnb\nNAME      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\naws-efs   Bound    pvc-43f6fe12-b9f3-400c-ba20-b357c1639f00   6Ki        RWX            aws-efs        4m44s</code></pre>\n<ol start=\"6\">\n<li>room pod application</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f deployment.yml</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119349966-bd9c6300-bcd9-11eb-9f6d-08e4a3ec82f0.PNG\" alt=\"pod with pvc\"></p>\n<ol start=\"7\">\n<li>Create a file in the mounted path in pod A and check the file in pod B</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">NAME                              READY   STATUS    RESTARTS   AGE\nefs-provisioner-f4f7b5d64-lt7rz   1/1     Running   0          14m\nroom-5df66d6674-n6b7n             1/1     Running   0          109s\nroom-5df66d6674-pl25l             1/1     Running   0          109s\nsiege                             1/1     Running   0          2d1h\n\n\nkubectl exec -it pod/room-5df66d6674-n6b7n room -n airbnb -- /bin/sh\n/ # cd /mnt/aws\n/mnt/aws # touch intensive_course_work</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119372712-9736f180-bcf2-11eb-8e57-1d6e3f4273a5.PNG\" alt=\"Create a file in a pod\"></p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl exec -it pod/room-5df66d6674-pl25l room -n airbnb -- /bin/sh\n/ # cd /mnt/aws\n/mnt/aws # ls -al\ntotal 8\ndrwxrws--x    2 root     2000          6144 May 24 15:44 .\ndrwxr-xr-x    1 root     root            17 May 24 15:42 ..\n-rw-r--r--    1 root     2000             0 May 24 15:44 intensive_course_work</code></pre>\n<p><img src=\"https://user-images.githubusercontent.com/38099203/119373196-204e2880-bcf3-11eb-88f0-a1e91a89088a.PNG\" alt=\"b Confirm file creation in pod\"></p>\n<ul>\n<li>Config Map</li>\n</ul>\n<p>1: Create cofingmap.yml file</p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f cofingmap.yml\n\n\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: airbnb-config\n  namespace: airbnb\ndata:\n  # 단일 key-value\n  max_reservation_per_person: &quot;10&quot;\n  ui_properties_file_name: &quot;user-interface.properties&quot;</code></pre>\n<ol start=\"2\">\n<li>Apply to deployment.yml</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f deployment.yml\n\n\n.......\n          env:\n\t\t\t# single key-value in cofingmap\n            - name: MAX_RESERVATION_PER_PERSION\n              valueFrom:\n                configMapKeyRef:\n                  name: airbnb-config\n                  key: max_reservation_per_person\n           - name: UI_PROPERTIES_FILE_NAME\n              valueFrom:\n                configMapKeyRef:\n                  name: airbnb-config\n                  key: ui_properties_file_name\n          volumeMounts:\n          - mountPath: &quot;/mnt/aws&quot;\n            name: volume\n      volumes:\n        - name: volume\n          persistentVolumeClaim:\n            claimName: aws-efs</code></pre>\n","sidebar":"started","next":"","prev":"","headings":[{"depth":1,"value":"AirBnB","anchor":"#airbnb"},{"depth":2,"value":"service scenario","anchor":"#service-scenario"},{"depth":2,"value":"CheckPoint","anchor":"#checkpoint"},{"depth":2,"value":"Analysis/Design","anchor":"#analysisdesign"},{"depth":2,"value":"avatar","anchor":"#avatar"},{"depth":3,"value":"· CQRS","anchor":"#·-cqrs"},{"depth":3,"value":"· API Gateway","anchor":"#·-api-gateway"},{"depth":2,"value":"Correlation","anchor":"#correlation"},{"depth":3,"value":"· Synchronous call (Sync) and Fallback handling","anchor":"#·-synchronous-call-sync-and-fallback-handling"},{"depth":3,"value":"· Asynchronous Invocation / Temporal Decoupling / Failure Isolation / Eventual Consistency Test","anchor":"#·-asynchronous-invocation--temporal-decoupling--failure-isolation--eventual-consistency-test"},{"depth":2,"value":"operation","anchor":"#operation"},{"depth":3,"value":"· CI/CD settings","anchor":"#·-cicd-settings"},{"depth":3,"value":"· Synchronous Call / Circuit Breaking / Fault Isolation","anchor":"#·-synchronous-call--circuit-breaking--fault-isolation"},{"depth":3,"value":"· Uninterrupted redistribution","anchor":"#·-uninterrupted-redistribution"},{"depth":2,"value":"Self-healing (Liveness Probe)","anchor":"#self-healing-liveness-probe"},{"depth":2,"value":"Config Map/ Persistence Volume","anchor":"#config-map-persistence-volume"}]},"allMarkdownPage":{"edges":[{"node":{"path":"/tool/on-prem-inst/","title":"Installing on-premise MSA-Easy"}},{"node":{"path":"/tool/google-drive-examples/","title":"Google Drive Examples"}},{"node":{"path":"/tool/infrastructure-modeling/","title":"Infrastructure Modeling (Kubernetes)"}},{"node":{"path":"/tool/event-storming-tool/","title":"EventStorming"}},{"node":{"path":"/tool/development-practice/","title":"Lecture development and practice environment"}},{"node":{"path":"/templates-language/go-template/","title":"Create a Go Template "}},{"node":{"path":"/tool/cloud-ide-tool/","title":"Cloud IDE"}},{"node":{"path":"/templates-language/python-template/","title":"Create python template "}},{"node":{"path":"/templates-language/springboot-java-template/","title":"Spring Boot/Java"}},{"node":{"path":"/started/","title":"Introduce"}},{"node":{"path":"/example-scenario/online-lecture/","title":"Internet lecture system"}},{"node":{"path":"/started/event-storming-learning/","title":"Event Storming Learning"}},{"node":{"path":"/started/domain-driven/","title":"Domain-Driven Design Learning"}},{"node":{"path":"/example-scenario/food-delivery/","title":"food delivery"}},{"node":{"path":"/example-scenario/library-system/","title":"library system"}},{"node":{"path":"/custom-template/tutorial/","title":"Custom Template Tutorial"}},{"node":{"path":"/example-scenario/animal-hospital/","title":"Veterinary Practice Management System"}},{"node":{"path":"/example-scenario/accommodation-reservation/","title":"AirBnB"}},{"node":{"path":"/custom-template/custom-template/","title":"Creating custom templates"}},{"node":{"path":"/contact/question/","title":"CONTACT"}}]}},"context":{}}