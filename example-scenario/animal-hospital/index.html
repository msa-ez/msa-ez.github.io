<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>동물병원 진료시스템 - msa-ez.github</title><meta name="gridsome:hash" content="4ced6c2755658a0619989a48aa52d7d77859097b"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.22"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="og:url" name="og:url" content="undefined/templates-language/springboot-java-template/"><meta data-vue-tag="ssr" name="description" content="undefined"><meta data-vue-tag="ssr" data-key="og:title" name="og:title" content="동물병원 진료시스템"><meta data-vue-tag="ssr" data-key="twitter:title" name="twitter:title" content="동물병원 진료시스템"><meta data-vue-tag="ssr" data-key="og:description" name="og:description" content="undefined"><meta data-vue-tag="ssr" data-key="twitter:description" name="twitter:description" content="undefined"><meta data-vue-tag="ssr" data-key="og:type" name="og:type" content="website"><meta data-vue-tag="ssr" data-key="twitter:card" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" data-key="og:image" name="og:image" content="undefined/logo.jpg"><meta data-vue-tag="ssr" data-key="twitter:image" name="twitter:image" content="undefined/logo.jpg"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.f0886199c685a75a52fccefb5e72c094.png"><link rel="preload" href="/assets/css/0.styles.8fa3adb2.css" as="style"><link rel="preload" href="/assets/js/app.06bb65f0.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--markdown-page-vue.7da4a730.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.c25ecd7a.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.4fb285f5.js"><link rel="prefetch" href="/assets/js/search.c1d5fc53.js"><link rel="stylesheet" href="/assets/css/0.styles.8fa3adb2.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="font-sans antialiased text-ui-typo bg-ui-background"><div class="flex flex-col justify-start min-h-screen"><header class="sticky top-0 z-10 w-full border-b bg-ui-background border-ui-border"><div class="py-2 border-t-2 border-ui-primary"><div class="container"><div class="flex items-center justify-between -mx-2 sm:-mx-4"><div class="flex flex-col items-center px-2 mr-auto sm:px-4 sm:flex-row"><a href="/" title="Home" class="flex items-center text-ui-primary active"><img src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 120 64' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-37afcb0017f229c304bfe602273e7d7c'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-37afcb0017f229c304bfe602273e7d7c)' width='120' height='64' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAiCAYAAADvVd%2bPAAAACXBIWXMAAC4jAAAuIwF4pT92AAATu0lEQVRo3sVZB3RU15lWIxhscMtunHhd8EkcJzFusb1xwMaAuoQkpFEFUWQwzXEMAQSYElFEkVCbGUmjikZdIJBAqIxmRgUJVRAqmGLABQdwTBDqZebdb/97Z0YIO1nvnrN7mHO%2b89/35pX5vvu3e8fKij69eQ4C48ffg7UZNgK5DrY9ufZ2wtJ5qwfw0cirrDSKahuCrRk0rrKuUFRb05h/Z1VhukZcP378g09vnr2VmZwtR4/Z8nNE9Ed/DAlhRfdM%2bS7X/QXkv/rWtrQ6R2cVW%2bSVNBDkoRoK9EwaCvBMGvQn60fwJcgIPnRuvkfSkBeNPWns4aEadCfrRseudN5lvmrAZU6SZJ%2bobA/Ry3XLyhXV7xPBXxGRh/%2b731PxQ3FsK%2bTi2Fojrx4TQtievP8BQSJHBJ8h%2bzrBje5ZQTaMhEulcTmN2%2bn7G925zgNS/n9K0enF3S5qwC8T8LFAfT9kZojjDMDbgkP34ENwIySnXkNraiN0CfUgAQbph39DaCQyeWT3EuHlhDk0/hXZx36MDxdovOUEnyC8SiQcyS4mbOnNtY8nW0K2lfAFobc/3wGGo05AsTNwwpXgBlbsIs4NHXZEb74zjPnvQJ2ROmKvgmF%2bUr%2bBZpQwZKDZFdaLjt0T%2bgyO8l6jo7zP6KzoNXok9hvpvJG8xUjXE8iqBgXck4alQ8ozxiq5zkAeIFUqa6BPqENNUiPqU1twOu0M6lKaUa06DRJghEhdJ9tMOMzFISwjOBB%2bTZh6T4Tq%2b1w4khU5Y6DAETjuQsRcTJbIGY%2b5YOiIM/oLnECCMAoJqTfP0XA3Z67hTsYfCTMMPbkORvpO6s51Yoa8P7JydTgcVWBeSf2MCDEiT3aI7ACzVwyyoBywtSVg60%2bCfXQcbH46mKNigK7n1wyJe4g8m0fH3nTPYUUj08n1jGafaUyQiKiRrIGsoeSgxngiUiOVx%2bpRlViPWhKHi3I6tZVEahXnuDiEvxHOE%2baYQ8DGIsBfOGma5REiQoTsDdxyknfVfzT2Z8%2bQutUzGHkI4yLczX6fjRx1ZWjczFC3FgN5c0iYuexunhNG8mayM1l/Zm4qIycCQSZpCB6JA5iXNIq4GiNi0ouxdsNWfLx2Azbt2IeUomZsLQOclIMgTwCJABIANPsIVPWgRFGLSnkVd39OBERaCFEep4dGXsM6T1xkFzRXWP2hFlYarZPoOyMXhgtEiZFbqVJRA62yFo3pbXR/tbNZAFshAM2gB3djImck8pwkiDyjmWcjDXvw93oFjLXr0Zv9Pj%2bPkWIvdGiS4ecfiDVr/oRvT8WiP3c2unMd2WDeLFzNCWZ%2bSXfZPNUwF0CQcoofRkLNABb6eYJeeR9%2bYm2FvZFyfFQEOCv76XqTAK5JI1iWeJtIVnHS4wWgcRU0cdVo03ZgzUdr4ObuhqK8YjTlnEVptNbiKXQvt0IwSdwrckjVS9/zAPtX%2b4h0r2WGcx2I0CzcOhUHV68ATHniKWzf8VdIdZvxj5RXITXtwRyne0T2hG0FqpbhH%2br30Jdnj9u57vgg%2bSu4qIxEZgDOij6sJnI790aZ77HGc88/D4c5s/DitKfFueAAH%2bypAubG9QnBvEgAZ/KYtYk3QBVAkK8wk9coq3EiogIXyj/Hnz7%2b09jvePq5X%2bBM5TlUxJgEEteaReMC8NxB9ibhSbMA1pYk%2bBTh9iDlAB7Ld7LeB8p9kZW4995M2U5GV2UyjHnv4FZNFJ5%2b/sWx75xc3IGG7ejOeAc9FAaDebOxPvUcnFQM3skDsCdSYVrAV%2bYtrqe3Iv%2b4Hse%2bBGLKbmK3IhcJFX%2bDd6oB81Q8bIaEAE4kwLaEL1Aj16LcLAAnw12/WtUA/YkqTJg4QQg6wW6CePaRjKOoS21GWaxuPHnuAcYauodE6Rgrg5ZEaK77nZYwuJNJAlQEID0uTDx00kMThd26eQNQvxJtxfsxYfLj45R/EX%2bvjUZ/9kx05zljNG8mDqSVw0FF5SypHw7yPoRSjK9eY5otG1tbTJ/%2bCjaHxyO%2b/BtENwMOCRLcE/oFeUqaYx5wIP7iPQHGzf4l3VX4%2bvmanmdjAzs7O7M3huNsQSdORlWOCVAhNwlwKrmJH580l0BrSx9gY06EpbwSmAVgqAhEauxO8VA7O1thX3jpFaArGcXJ2%2bnYZlwc/wS1R6IgFbngdraj8JJDhw5hLglApVAkQK9UBrXmMn75H0/cF///9thD%2bGjVCiTV9sFNNUKxPyBEsOQAaoJQZRaAk%2bEzW5/WguL847CyNj3DP8Afb775phgHBgbifNlllERqxvKFWQgDrwpklUIARZWtEIB3fOYwUPLSx7P/ncxZgCYIqqi/iodOmGAnwMe1ZflIVR4Q45df/h0ef/wxMY4O/xTQLsJ3mbNFL1Cq3sdLIcWzKam5xvcjOJshobgD/rL5eOZnj90nxKrlS7GbwsRe3i9yABeAyiCylS0iB5TLq8Xsl0RocKn6Khwc7cV9EydOxMWOi/Dy9BLHr73xKs5VdKIsalwIiKpRZeA9Ax1vMMe/ncUDzALYrxWl0CQAQ%2bVCKCO2i4c%2b9dTP4OnhIcZLQ5ZhY2ioGIeGbsK7774rxgEBgZQHNuN2xkyM5L%2bHlqy1cFeNjlUB14RBEgDYcwpQtALyir9jx/54/PQJUyg9%2begkJJR9SbNOiVM1IMjLVP04qjgNrVwv4v9kdCWas9qQmZo1JpyrmytGuw1YtWKVOJ7y6BToi2qgU9bR7OvHl00j7w/oOf7fL4G25hDwko5ZQoALEIy4/dtMbvrTJ3HsWLGItUcfnYpp06aJ88XHCvHh8uVi/NL036O7LhI9WTOpL5iNKzmLIEvqhQfVcj77Kw8DyowiBPnLsDu%2bENHlt1F%2b5hZeefm34v5HH54A5YmLmJfCSIB%2bCodhLErsRin1ABpz7Jce1OJCzWW88ebrYwLYUfKbNu15PPPsM2PnUpSpaFJTOYzRmgQwlUGmja/lx3%2bwlECzBzjYmEPgDXMZxJ3M9xh35%2bjwreKBDz00Cd9c6YCri5M56ViLHHCp/ggU%2b03XTJryBGs7GQdDoT3rz7dnd3Jd2AfJX1MzY2C8tMnrgHffnm66n/D8009i6iOTxn60y5wZiKk2Yq58kHknk8ckG9kq1W1mnn1WElXJ2g6fR1yU3PQMaxtMpOQ8cfLEsWfY2ppy1bpP1qG96AKoQxyrAryF1pjWEc9YSqBoh3vNy1kS4t8pHLoHqKcnASRol7DI3Z9ayOFWSzYKUvaPvWzi1J%2bhpzUJukyRKBlHbPgmSOXB0lfy6axAsYknM9ENcg9YXgCosk7gtd88B7txsT/RlsjPnQl15efwPcTYvERqiVW8ctyR1sZclKoVep4AWUVsFdprOjHtxWlj9xYVFAt3z07JwY6tOzB58mRTWXZ2wnmNSIRi5ikEJF0CD4mqL%2bj4ke/3AJZ22I7GF0YKnXFH/a4E/VIWtuUT88sm4sLJfRhqjMCiZWvw%2b7dnQBF7EJJ%2bNb6sjMD7rv7s3VmzkZGWIn2e4YfCXZ6QJXZL85JHqAz2Md4LuJAIHx6h2NcPIiK7CfsT8nFAVYD4oy2IqzVAdshIOWOAucXdwtwdTdI721vx6f561MRXSWWiqalmLaVtKMopRtS%2baCTGJ6L95GfQxp0S/f71MzcoDF8Sv3fq41PRUNLMKuNqxMxTCzzK1wZE%2bizn2nTo3L29Ab7eH/OCXIdyvrojDzCgcjGRjMKvf/caZEEhuF4bj%2bH8WaIbNDbuAXTL0JM5A/0ngjHaEoEbpaHSxewQtOz%2bzTerFU2pjqnU28cbpbnxYPbxIHIGeCTcxaK0r7D%2byDdYkAsEZQGeKcCcGAluSgN5DHWCu65Is7e04q3QlvbMyLq6hsRGEBGpMo5qeUw1TiU3oyW7HWfyO6gk6kWio4UQTqkboSmqRPS%2bGGzaFMpOVzSxshgdjkeVGYoiS8V1ZHdxnof3FtmMXwqLRsg8TuCVQCyG8p1Yb00Yhhv2AY3bMXDMB3ezqd9Xz8DdjD9wkajrcyQRZqEn/Q%2bs/q/TUfHpa7i2Y/J7ATmG5esKv8POww2G5JJjrESbgDP12/F162o20uWDr5rWMO%2b0a8yn8DjzP6JBwJEa5lvQAN%2b8s8w9vgLOUSfhrM5aWnjo%2bMky9SkUJdJqL0HLSuN1KJPrGFUDgXEZHnwlSJ0ea8lpZ53FF3E0%2bgSTr08YTd2WAcWGxMHotfLFltnftTL8BxsetuY8sMHSC4hFURatANXvsDu8xc2ZLdYJRJrgxFeGUm%2bBg9RX7MJ6S93ZdfKcm1r324aLvvqecwu6Bzr8YOhwZaxjDkPnbOAzdxjPe8Jw3oN1t4Vg5dFTWFC9E0uqd7HF1buwuHo3FmjD2ELdHgTrw43Bur1scdVBLNVFsg%2b0B7FCE81Wl8fiz6UKdlRVYdDKawyU3fmqT7q3OtQxnvmPR5Qb4zcmSenbMxEfmtSYuDnlRc6vOaPdOnz1/vs3Q3pMe34WD5hvpFJI5EfFyjDPicPA1/9mUfi6H/0FDhjimyM6dwx/JmPD52Ug4ky67A9c8QEuuAGfyxi%2bDgFuUvt8YyOGaeYHO2VsiOxohz/bUZrd76eNYot1kQjWRrIg3QGsaVVhdUsiW96oQMjpWCyoiWB%2bleEkyAG2UH8AgVX72BJ9JDTqOjSmnEVtciP0CfWoVIryxpOdQRd/auRY5EmoNqciYVNypGWSlRtVdiSGZXzfbpDYD7SUwkGqAhyjtC7grTHfFLFskBiPibUCx0BPtv3XfSddLnHyQ50%2bBBkG2z0Zu7bG2H01RTpTk4Dighi2J2wD2xW2DX1XDmCkcx4b6PQDzntJmQ1/OS/TRklLiViQbj%2bLbi6APCuZRWUmQHE4nSmLM5i6rpjtbctDYCV5gz6SPCUSIdqDdwuTyg9o42oyyANqiTjP7AN8rc/zQ2P6WaRtU9%2bKWadws5An4rYW4hYRvh8C1mb7C8JNwrdUEtvJaqk6ZJDdTZ7C9wE9qGN8m1z/%2bW8/fMVu6Jz3NCI/NEoiDLR7M1wJRIM%2bFT9/5mXKxrb3St0jv8D1LjWkC57o7/BlJADyGz8xkAAsuHIvVjQpWUZR3n2t8aQJEzHJegKiE%2bVY15aKQE24tLQumnvD1fv29xRVD5EAz9KMzqCMv6AkWrOZZv9Z/l3iphRbImxtFsGKPOKfbxJaNkaJHN8ZfpaOn6Txj253D1/yfWi4S3YFl/3Q1%2bYp4cYKpCbsFgR%2b%2b9uXUHQkFV2tJzB6tw34ZiMGzrmxwS7hAexQw3r4aKNAHsACdfsQ1VoAZX4aEnLTsHLlyjEhFNkpWNOSiCDNXuPS%2bhgs0kV05aaW2DUcbLQ5mJfzL3%2bjZdZ/lPz4rfF/5hm8U%2bTrBfresl1u03vUyXqg1kOEDQmgwxcB3AOMuBbIasqU4oe//tprqNEeQUzEpwhe4IfTmjjgajDr455yfj7i60MZCUAxfQCL9BHMXxOO1W0q6L48g7feMK3swnaGIfryccjKKUnqI408LwTrIk7z966siLVWqQutzP8BUFdXZVOpqLE9GVNpm/xpuhAmb0/hjxO/rxka/ydI7g//IOkR5%2bytyO05caEwxb4KXwVisENmYBe92NWzKkx%2b5Kc/2PZKT9oPXF%2bBvnNeYF3z2cG6LYxCAEIASoABur3Iv6DHrHdmiuuXLQlB2tVK%2bFRw8hFE/IAxpCGOi1XO30vWms5ZBBC/nxKgFVUBq5xdBeK4cP/x/59/ZYY7ZWMCkP2ECzDU6WsY6XRF3zUFXvilqedXxh3A9YslGL7TAgwVstHz89kgJUzpMx8WXreN%2bVJ5W0qzL9PshvqaDouCFor7fLy8UXyjCX41%2b3gCFB5CZA0fNMZxIXL5e8nacAEeyIdI3xOgU%2baKq/4Y6vI1Dp5zZrh5EHPmmhZN0ZF7kK%2bOwIchPliyZAn7x6VYIj%2bP3WnxxpbqHQjURzH/it3Y1ZWHzVu3iHsmP/wwktNSkFqej3R9Idvdms0CtXt5CIwua1ZwMUQaX1QVaUtjqwf2IQFEDhjqkv2OavzoyHlf9J11ZfhuB1auWvP9EGDP/fItfNGexq5o5qC2wElaVblrMLg6iuJ7J1NeKkGgt98PwoZewLLKjmBZo1xaoNk3%2bkGTHEFl4aH8vUGle2wftAdYm8Y%2bU2l8Q7roR3nARyJLeSCJ7dgWyhTR21FRFMsutaaykb%2blse5ziw1njs6G9qjHroCq6Mshp6K4S0tLa6JYWlsJk%2belsMg0BYtMjGWb92xnO8J3Ql5fYHTP3Ajv7C20tF471ti4xn/8QGd/DObjRlzxp25PZhzsmM%2bki74Svv2LETc/MuDLhQZc8jZKn7kZBju80JA3J/vnl5unUOLrXVwVyV3asFC73xig32dY3qQwfNSqMmxoPzS6uTPTsPVCzohfcRhcEv4Mt8RPVo%2bRV5rIU1l8sCJQNbAxVwI1rvnzjnB4hJoi4wVfsAteprb4C2qPPydcDcTNBq/O9t9Y/URWp3xhMWX/pXUx4M1NSEMsd3MsJcux%2bDQ1PHVRWNQQDc%2bM0H4X5ccu/D00tvVI3yA8z0sdahV4YveDE2BIVAIfO7MYu3B3MXhDRCIY6PjWcJdvM9kcQhghkM7/J7uyYAq/fr12%2b%2bRgfcTvyQveJw9wpzAIIruKsJGwkxBD3pG2sGJfjkfahtf5PfPS1tvNS1on3u2mWmvlmbLe6oF/7uUB2duErQR3wnTCo//qnqpyX5v/7Xvck9eNdXWc/P/l578AjufF27Pdj9IAAAAASUVORK5CYII=' /%3e%3c/svg%3e" width="120" data-src="/assets/static/logo.1539b60.bd727e13501e82a0ba322b4ad29fd33a.png" data-srcset="/assets/static/logo.1539b60.bd727e13501e82a0ba322b4ad29fd33a.png 120w" data-sizes="(max-width: 120px) 100vw, 120px" class="text-ui-primary g-image g-image--lazy g-image--loading"><noscript><img src="/assets/static/logo.1539b60.bd727e13501e82a0ba322b4ad29fd33a.png" class="text-ui-primary g-image g-image--loaded" width="120"></noscript></a></div><div class="w-full px-2 sm:px-4 max-w-screen-xs"><!----></div><div class="flex items-center justify-end px-2 sm:px-4"><!----><!----><!----><button aria-label="Toggle Darkmode" title="Toggle Darkmode" class="ml-2 sm:ml-8"><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></div></div></div></div></header><main class="container relative flex flex-wrap justify-start flex-1 w-full bg-ui-background"><!----><div class="w-full pb-24"><div class="flex flex-wrap items-start justify-start"><div class="order-2 w-full md:w-1/3 sm:pl-4 md:pl-6 lg:pl-8 sticky" style="top:4rem;"><div class="mt-8 sm:pl-4 md:pl-6 md:pt-12 lg:pl-8 sm:pb-16 sm:border-l border-ui-border md:mt-0"><h3 class="pt-0 mt-0 text-sm tracking-wide uppercase border-none">On this page</h3><div><ul><li class="font-semibold depth-2"><a href="/example-scenario/animal-hospital/#헥사고날-아키텍처-다이어그램-도출" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          헥사고날 아키텍처 다이어그램 도출
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#ddd-의-적용" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          DDD 의 적용
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#동기식-호출과-fallback-처리" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          동기식 호출과 Fallback 처리
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#클러스터-적용-후-rest-api-의-테스트" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          클러스터 적용 후 REST API 의 테스트
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#비동기식-호출과-eventual-consistency" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          비동기식 호출과 Eventual Consistency
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#api-게이트웨이" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          API 게이트웨이
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#gateway-설정-파일" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          Gateway 설정 파일
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#oauth-인증-적용" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          Oauth 인증 적용.
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#cicd-설정" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          CI/CD 설정
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#동기식-호출--서킷-브레이킹--장애격리" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          동기식 호출 / 서킷 브레이킹 / 장애격리
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#오토스케일-아웃" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          오토스케일 아웃
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#무정지-재배포" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          무정지 재배포
        </a></li></ul></div></div></div><div class="order-1 w-full md:w-2/3"><div class="content"><h1 id="동물병원-진료시스템"><a href="#%EB%8F%99%EB%AC%BC%EB%B3%91%EC%9B%90-%EC%A7%84%EB%A3%8C%EC%8B%9C%EC%8A%A4%ED%85%9C" aria-hidden="true"><span class="icon icon-link"></span></a>동물병원 진료시스템</h1>
<h1 id="2조-과제---동물병원-진료시스템-구축"><a href="#2%EC%A1%B0-%EA%B3%BC%EC%A0%9C---%EB%8F%99%EB%AC%BC%EB%B3%91%EC%9B%90-%EC%A7%84%EB%A3%8C%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B5%AC%EC%B6%95" aria-hidden="true"><span class="icon icon-link"></span></a>2조 과제 - 동물병원 진료시스템 구축</h1>
<p>이 시스템은 MSA/DDD/Event Storming/EDA 를 포괄하는 분석/설계/구현/운영 전단계를 커버하도록 구성하였습니다.
이 시스템은 클라우드 네이티브 애플리케이션 Final Project 수행 테스트를 통과하기 위한 답안을 포함합니다.</p>
<h1 id="table-of-contents"><a href="#table-of-contents" aria-hidden="true"><span class="icon icon-link"></span></a>Table of contents</h1>
<ul>
<li>
<p>[동물병원 진료시스템]</p>
<ul>
<li><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4">서비스 시나리오</a></li>
<li><a href="#%EB%B6%84%EC%84%9D%EC%84%A4%EA%B3%84">분석/설계</a></li>
<li>
<p><a href="#%EA%B5%AC%ED%98%84">구현</a></p>
<ul>
<li><a href="#ddd-%EC%9D%98-%EC%A0%81%EC%9A%A9">DDD 의 적용</a></li>
<li><a href="#%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C%EA%B3%BC-Fallback-%EC%B2%98%EB%A6%AC">동기식 호출과 Fallback 처리</a></li>
<li><a href="#%EB%B9%84%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C%EA%B3%BC-Eventual-Consistency">비동기식 호출과 Eventual Consistency</a></li>
<li><a href="#API-%EA%B2%8C%EC%9D%B4%ED%8A%B8%EC%9B%A8%EC%9D%B4">API 게이트웨이</a></li>
<li><a href="#oauth">Oauth</a></li>
</ul>
</li>
<li>
<p><a href="#%EC%9A%B4%EC%98%81">운영</a></p>
<ul>
<li><a href="#cicd-%EC%84%A4%EC%A0%95">CI/CD 설정</a></li>
<li><a href="#%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C--%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%ED%82%B9--%EC%9E%A5%EC%95%A0%EA%B2%A9%EB%A6%AC">동기식 호출 / 서킷 브레이킹 / 장애격리</a></li>
<li><a href="#%EC%98%A4%ED%86%A0%EC%8A%A4%EC%BC%80%EC%9D%BC-%EC%95%84%EC%9B%83">오토스케일 아웃</a></li>
<li><a href="#%EB%AC%B4%EC%A0%95%EC%A7%80-%EC%9E%AC%EB%B0%B0%ED%8F%AC">무정지 재배포</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="서비스-시나리오"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4" aria-hidden="true"><span class="icon icon-link"></span></a>서비스 시나리오</h1>
<p>기능적 요구사항
1. 고객은 동물병원에 예약 및 예약 취소 변경을 한다.
1. 예약이 완료된 고객은 진료를 받는다.
1. 수납은 고객에게 진료비를 청구한다.
1. 고객이 치료비를 지불한다.
1. 예약이 변경/취소되면 진료/처방이 변경/취소된다.
1. 예약상태가 바뀔 때 마다 카톡으로 알림을 보낸다.
1. 고객은 Lookup 시스템에서 예약 상태를 조회할 수 있다.</p>
<p>비기능적 요구사항
1. 트랜잭션
1. 진료가 불가능 할 때는 예약이 불가능해야 한다. Sync 호출
1. 장애격리
1. 예약/진료 시스템(core)만 온전하면 시스템은 정상적으로 수행되어야 한다.  Async (event-driven), Eventual Consistency
1. 문자 알림, 치료비 수납 시스템에 장애가 생겨도 예약/진료 (core) 시스템은 정상적으로 작동한다.
1. 진료시스템이 과중되면 예약을 잠시후에 하도록 유도한다.  Circuit breaker, fallback
1. 성능
1. 고객이 예약/진료/치료 결과를 시스템에서 확인할 수 있어야 한다.(Lookup 시스템으로 구현, CQRS)
1. 알림 시스템을 통해 예약/예약취소/예약변경 내용을 문자로 알림을 줄 수 있어야 한다. (Event driven)</p>
<h1 id="분석설계"><a href="#%EB%B6%84%EC%84%9D%EC%84%A4%EA%B3%84" aria-hidden="true"><span class="icon icon-link"></span></a>분석/설계</h1>
<ul>
<li>이벤트스토밍 결과:  <a href="http://msaez.io/#/storming/0vtSW2vBLoZTFiAsgdwS6H7ODs33/every/2dac041f4e652d598a042694dfa26b20/-M5LTyP4cBS9IpsqYq0h" target="_blank" rel="noopener noreferrer">http://msaez.io/#/storming/0vtSW2vBLoZTFiAsgdwS6H7ODs33/every/2dac041f4e652d598a042694dfa26b20/-M5LTyP4cBS9IpsqYq0h</a></li>
</ul>
<ul>
<li>Core Domain : 예약 (Reservation) 및 진료 (Diagnosis) 도메인</li>
<li>Supporting Domain : Lookup(CQRS) 도메인</li>
<li>General Domain : 알림(notice) 시스템.</li>
</ul>
<h2 id="헥사고날-아키텍처-다이어그램-도출"><a href="#%ED%97%A5%EC%82%AC%EA%B3%A0%EB%82%A0-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98-%EB%8B%A4%EC%9D%B4%EC%96%B4%EA%B7%B8%EB%9E%A8-%EB%8F%84%EC%B6%9C" aria-hidden="true"><span class="icon icon-link"></span></a>헥사고날 아키텍처 다이어그램 도출</h2>
<p><img src="https://user-images.githubusercontent.com/38850007/79833622-aad4a200-83e6-11ea-80f1-6eb9a59503af.png" alt="image"></p>
<h1 id="구현"><a href="#%EA%B5%AC%ED%98%84" aria-hidden="true"><span class="icon icon-link"></span></a>구현:</h1>
<p>분석/설계 단계에서 도출된 헥사고날 아키텍처에 따라, 각 BC별로 대변되는 마이크로 서비스들을 스프링부트로 구현하였다. 구현한 각 서비스를 로컬에서 실행하는 방법은 아래와 같다 (각자의 포트넘버는 8081 ~ 808n 이다)</p>
<p>동물병원 예약/진료 시스템은 아래의 7가지 마이크로 서비스로 구성되어 있다.</p>
<ol>
<li>게이트 웨이: <a href="https://github.com/AnimalHospital2/gateway.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/gateway.git</a></li>
<li>Oauth 시스템: <a href="https://github.com/AnimalHospital2/ouath.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/ouath.git</a></li>
<li>예약 시스템: <a href="https://github.com/AnimalHospital2/reservation.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/reservation.git</a></li>
<li>진료 시스템: <a href="https://github.com/AnimalHospital2/diagnosis.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/diagnosis.git</a></li>
<li>수납 시스템: <a href="https://github.com/AnimalHospital2/acceptance.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/acceptance.git</a></li>
<li>알림 시스템: <a href="https://github.com/AnimalHospital2/notice.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/notice.git</a></li>
</ol>
<ul>
<li>게이트웨이 시스템은 수업시간에 이용한 예제를 프로젝트에 맞게 설정을 변경하였다. </li>
<li>Oauth 시스템은 수업시간에 이용한 예제를 그대로 활용하였다.</li>
</ul>
<p>모든 시스템은 Spring Boot로 구현하였고 <code>mvn spring-boot:run</code> 명령어로 실행할 수 있다.</p>
<h2 id="ddd-의-적용"><a href="#ddd-%EC%9D%98-%EC%A0%81%EC%9A%A9" aria-hidden="true"><span class="icon icon-link"></span></a>DDD 의 적용</h2>
<ul>
<li>각 서비스내에 도출된 핵심 Aggregate Root 객체를 Entity 로 선언하였다: (예시는 예약 시스템의 Reservation.class). 이때 가능한 현업에서 사용하는 언어 (유비쿼터스 랭귀지)를 그대로 사용하려고 노력했다.</li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation<span class="token punctuation">.</span>external<span class="token punctuation">.</span></span><span class="token class-name">MedicalRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation<span class="token punctuation">.</span>external<span class="token punctuation">.</span></span><span class="token class-name">MedicalRecordService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span></span><span class="token class-name">Processor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span></span><span class="token class-name">MessageChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span></span><span class="token class-name">MessageHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">MessageBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">MimeTypeUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"RESERVATION"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Reservation</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> reservatorName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> reservationDate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> phoneNumber<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostPersist</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishReservationReservedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">MedicalRecord</span> medicalRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MedicalRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        medicalRecord<span class="token punctuation">.</span><span class="token function">setReservationId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        medicalRecord<span class="token punctuation">.</span><span class="token function">setDoctor</span><span class="token punctuation">(</span><span class="token string">"Brad pitt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        medicalRecord<span class="token punctuation">.</span><span class="token function">setMedicalOpinion</span><span class="token punctuation">(</span><span class="token string">"별 이상 없습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        medicalRecord<span class="token punctuation">.</span><span class="token function">setTreatment</span><span class="token punctuation">(</span><span class="token string">"그냥 집에서 푹 쉬면 나을 것입니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MedicalRecordService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">diagnosis</span><span class="token punctuation">(</span>medicalRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// Reserved 이벤트 발생</span>

        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReservationReserved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"JSON format exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Processor</span> processor <span class="token operator">=</span> <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageChannel</span> outputChannel <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span>
                <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">.</span>CONTENT_TYPE<span class="token punctuation">,</span> <span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostUpdate</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishReservationChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReservationChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"JSON format exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Processor</span> processor <span class="token operator">=</span> <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageChannel</span> outputChannel <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span>
                <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">.</span>CONTENT_TYPE<span class="token punctuation">,</span> <span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostRemove</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishReservationCanceledEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReservationCanceled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"JSON format exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Processor</span> processor <span class="token operator">=</span> <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageChannel</span> outputChannel <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span>
                <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">.</span>CONTENT_TYPE<span class="token punctuation">,</span> <span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getReservatorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reservatorName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReservatorName</span><span class="token punctuation">(</span><span class="token class-name">String</span> reservatorName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reservatorName <span class="token operator">=</span> reservatorName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getReservationDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reservationDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReservationDate</span><span class="token punctuation">(</span><span class="token class-name">String</span> reservationDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reservationDate <span class="token operator">=</span> reservationDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPhoneNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> phoneNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPhoneNumber</span><span class="token punctuation">(</span><span class="token class-name">String</span> phoneNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phoneNumber <span class="token operator">=</span> phoneNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>Entity Pattern 과 Repository Pattern 을 적용하여 JPA 를 통하여 다양한 데이터소스 유형 (RDB or NoSQL) 에 대한 별도의 처리가 없도록 데이터 접근 어댑터를 자동 생성하기 위하여 Spring Data REST 의 RestRepository 를 적용하였다.
RDB로는 H2를 사용하였다. </li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">CrudRepository</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReservationRepository</span> <span class="token keyword">extends</span> <span class="token class-name">CrudRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Reservation</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<ul>
<li>적용 후 REST API 의 테스트</li>
</ul>
<p>주의!!! reservation 서비스에는 FeignClient가 적용되어 있다. 여기에 diagnosis 시스템의 api 주소가 하드코딩되어 있어 로컬 테스트 환경과
Cloud 테스트 환경에서는 그 값을 달리하여 테스트하여야 한다.</p>
<p>package com.example.reservation.external.MedicalRecordService의 내용을 테스트 환경에 따라 변경해준다.;</p>
<ul>
<li>Local 환경 테스트시 </li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"diagnosis"</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8083"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MedicalRecordService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> path <span class="token operator">=</span> <span class="token string">"/medicalRecords"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">diagnosis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MedicalRecord</span> medicalRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>Cloud 환경 테스트시</li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"diagnosis"</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">"http://diagnosis:8080"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MedicalRecordService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> path <span class="token operator">=</span> <span class="token string">"/medicalRecords"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">diagnosis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MedicalRecord</span> medicalRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>아래의 명령어는 httpie 프로그램을 사용하여 입력한다.</p>
<pre class="language-text"><code class="language-text"># 예약 서비스의 예약
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot;

# 예약 서비스의 예약 취소
http delete localhost:8081/reservations/1

# 예약 서비스의 예약 변경
http patch localhost:8081/reservations/1 reservationDate=&quot;2020-05-01&quot;

# 진료 기록 리스트 확인
http localhost:8083/medicalRecords</code></pre>
<h2 id="동기식-호출과-fallback-처리"><a href="#%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C%EA%B3%BC-fallback-%EC%B2%98%EB%A6%AC" aria-hidden="true"><span class="icon icon-link"></span></a>동기식 호출과 Fallback 처리</h2>
<p>분석단계에서의 조건 중 하나로 예약(reservation)->진료(diagnosis) 간의 호출은 동기식 일관성을 유지하는 트랜잭션으로 처리하기로 하였다. 호출 프로토콜은 이미 앞서 Rest Repository 에 의해 노출되어있는 REST 서비스를 FeignClient 를 이용하여 호출하도록 한다. </p>
<ul>
<li>진료서비스를 호출하기 위하여 FeignClient를 이용하여 Service 대행 인터페이스 (Proxy) 를 구현 </li>
</ul>
<pre class="language-text"><code class="language-text"># (app) 결제이력Service.java
package com.example.reservation.external;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@FeignClient(name = &quot;diagnosis&quot;, url = &quot;http://diagnosis:8080&quot;)
  public interface MedicalRecordService {

    @RequestMapping(method = RequestMethod.POST, path = &quot;/medicalRecords&quot;)
    public void diagnosis(@RequestBody MedicalRecord medicalRecord);
}</code></pre>
<ul>
<li>예약완료 직후(@PostPersist) 진단을 요청하도록 처리</li>
</ul>
<pre class="language-text"><code class="language-text"># Reservation.java (Entity)
    @PostPersist
       public void publishReservationReservedEvent() {
   
           // 예약이 발생하면 바로 진료 진행.
           MedicalRecord medicalRecord = new MedicalRecord();
   
           medicalRecord.setReservationId(this.getId());
           medicalRecord.setDoctor(&quot;Brad pitt&quot;);
           medicalRecord.setMedicalOpinion(&quot;별 이상 없습니다.&quot;);
           medicalRecord.setTreatment(&quot;그냥 집에서 푹 쉬면 나을 것입니다.&quot;);
   
           ReservationApplication.applicationContext.getBean(MedicalRecordService.class).diagnosis(medicalRecord);
   
   
           // Reserved 이벤트 발생
           ObjectMapper objectMapper = new ObjectMapper();
           String json = null;
   
           try {
               json = objectMapper.writeValueAsString(new ReservationReserved(this));
           } catch (JsonProcessingException e) {
               throw new RuntimeException(&quot;JSON format exception&quot;, e);
           }
   
           Processor processor = ReservationApplication.applicationContext.getBean(Processor.class);
           MessageChannel outputChannel = processor.output();
   
           outputChannel.send(MessageBuilder
                   .withPayload(json)
                   .setHeader(MessageHeaders.CONTENT_TYPE, MimeTypeUtils.APPLICATION_JSON)
                   .build());</code></pre>
<ul>
<li>동기식 호출에서는 호출 시간에 따른 타임 커플링이 발생하며, 진단 시스템이 장애가 나면 예약도 못받는다는 것을 확인.(비즈상 무리가 있음..) </li>
</ul>
<pre class="language-text"><code class="language-text"># 진료 (diagnosis) 서비스를 잠시 내려놓음 (ctrl+c)

# 예약 처리
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot; #Fail

#진료 서비스 재기동
cd diagnosis
mvn spring-boot:run

#예약처리
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot; #Success</code></pre>
<h2 id="클러스터-적용-후-rest-api-의-테스트"><a href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%A0%81%EC%9A%A9-%ED%9B%84-rest-api-%EC%9D%98-%ED%85%8C%EC%8A%A4%ED%8A%B8" aria-hidden="true"><span class="icon icon-link"></span></a>클러스터 적용 후 REST API 의 테스트</h2>
<ul>
<li><a href="http://52.231.118.148:8080/medicalRecords/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/medicalRecords/</a>     		//diagnosis 조회</li>
<li><a href="http://52.231.118.148:8080/reservations/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservations/</a>       		//reservation 조회 </li>
<li><a href="http://52.231.118.148:8080/reservations" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservations</a> reservatorName="pdc" reservationDate="202002" phoneNumber="0103701" //reservation 요청 </li>
<li>Delete <a href="http://52.231.118.148:8080/reservations/1" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservations/1</a> 	//reservation Cancel  Sample</li>
<li><a href="http://52.231.118.148:8080/reservationStats/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservationStats/</a>   	  //lookup  조회</li>
<li><a href="http://52.231.118.148:8080/financialManagements/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/financialManagements/</a> 	//acceptance 조회</li>
</ul>
<ul>
<li>또한 과도한 예약 요청시에 서비스 장애가 도미노 처럼 벌어질 수 있다. (서킷브레이커, 폴백 처리는 운영단계에서 설명한다.)</li>
</ul>
<h2 id="비동기식-호출과-eventual-consistency"><a href="#%EB%B9%84%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C%EA%B3%BC-eventual-consistency" aria-hidden="true"><span class="icon icon-link"></span></a>비동기식 호출과 Eventual Consistency</h2>
<p>진료가 이루어진 후에 수납시스템으로 이를 알려주는 행위는 동기식이 아니라 비 동기식으로 처리하여 수납 시스템의 처리를 위하여 예약/진료 시스템이 블로킹 되지 않아도록 처리한다.</p>
<ul>
<li>이를 위하여 진료이력을 남긴 후에 곧바로 진료가 이루어졌다는 이벤트를를 카프카로 송출한다(Publish)</li>
</ul>
<pre class="language-text"><code class="language-text">// package Animal.Hospital.MedicalRecord;

    @PrePersist
    public void onPrePersist(){
        Treated treated = new Treated();
        BeanUtils.copyProperties(this, treated);
        treated.publish();
    }</code></pre>
<ul>
<li>수납 서비스에서는 진료완료 이벤트에 대해서 이를 수신하여 자신의 정책을 처리하도록 PolicyHandler 를 구현한다:</li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">FinancialManagementRepository</span> financialManagementRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">TreatedEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">Treated</span> treated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>treated<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"Treated"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"수납요청 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">FinancialManagement</span> financialManagement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinancialManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialManagement<span class="token punctuation">.</span><span class="token function">setReservationId</span><span class="token punctuation">(</span>treated<span class="token punctuation">.</span><span class="token function">getReservationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialManagement<span class="token punctuation">.</span><span class="token function">setFee</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialManagementRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>financialManagement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>알림 시스템은 실제로 문자를 보낼 수는 없으므로, 예약/변경/취소 이벤트에 대해서 System.out.println 처리 하였다.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>notice</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReservationReservedEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ReservationReserved</span> reservationReserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reservationReserved<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ReservationReserved"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"예약 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReservationChangedEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ReservationChanged</span> reservationChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reservationChanged<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ReservationChanged"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"예약 변경 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReservationCanceledEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ReservationCanceled</span> reservationCanceled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reservationCanceled<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ReservationCanceled"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"예약 취소 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>수납, Lookup(CQRS) 시스템은 예약/진료와 완전히 분리되어있으며, 이벤트 수신에 따라 처리되기 때문에, 수납/Lookup 시스템이 유지보수로 인해 잠시 내려간 상태라도 예약/진료를 하는데 문제가 없다:</p>
<pre class="language-text"><code class="language-text"># 수납 서비스 (acceptance) 를 잠시 내려놓음 (ctrl+c)

#예약처리
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot; #Success

#예약상태 확인
http localhost:8081/reservations     # 예약 추가 된 것 확인

#수납 서비스 기동
cd acceptance
mvn spring-boot:run

#수납상태 확인
http localhost:8085/financialManagements     # 모든 예약-진료에 대해서 요금이 청구되엇음을 확인.</code></pre>
<h2 id="api-게이트웨이"><a href="#api-%EA%B2%8C%EC%9D%B4%ED%8A%B8%EC%9B%A8%EC%9D%B4" aria-hidden="true"><span class="icon icon-link"></span></a>API 게이트웨이</h2>
<ul>
<li>Local 테스트 환경에서는 localhost:8080에서 Gateway API 가 작동.</li>
<li>Cloud 환경에서는 <a href="http://52.231.118.148:8080" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080</a> 에서 Gateway API가 작동.</li>
<li>application.yml 파일에 프로파일 별로 Gateway 설정.</li>
</ul>
<h3 id="gateway-설정-파일"><a href="#gateway-%EC%84%A4%EC%A0%95-%ED%8C%8C%EC%9D%BC" aria-hidden="true"><span class="icon icon-link"></span></a>Gateway 설정 파일</h3>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8088</span>

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> default
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token key atrule">jwk-set-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8088/.well<span class="token punctuation">-</span>known/jwks.json
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> reservation
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8081</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservations/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> diagnosis
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8083</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/medicalRecords/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> lookup
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8084</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservationStats/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> acceptance
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8085</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/financialManagements/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> oauth
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8090</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/oauth/<span class="token important">**</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>


<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> docker
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token key atrule">jwk-set-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/.well<span class="token punctuation">-</span>known/jwks.json
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> reservation
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//reservation<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservations/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> diagnosis
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//diagnosis<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/medicalRecords/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> lookup
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//lookup<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservationStats/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> acceptance
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//acceptance<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/financialManagements/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> oauth
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//oauth<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/oauth/<span class="token important">**</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></code></pre>
<h2 id="oauth-인증-적용"><a href="#oauth-%EC%9D%B8%EC%A6%9D-%EC%A0%81%EC%9A%A9" aria-hidden="true"><span class="icon icon-link"></span></a>Oauth 인증 적용.</h2>
<ul>
<li>Oauth 인증 적용. </li>
<li>But, 수업 중에 사용한 Oauth 프로젝트를 그대로 이용하여 Gateway에 붙이기만 함.</li>
</ul>
<h1 id="운영"><a href="#%EC%9A%B4%EC%98%81" aria-hidden="true"><span class="icon icon-link"></span></a>운영</h1>
<h2 id="cicd-설정"><a href="#cicd-%EC%84%A4%EC%A0%95" aria-hidden="true"><span class="icon icon-link"></span></a>CI/CD 설정</h2>
<p>각 구현체들은 각자의 Git을 통해 빌드되며, Git Master에 트리거 되어 있다. pipeline build script 는 각 프로젝트 폴더 이하에 azure_pipeline.yml 에 포함되었다.</p>
<p>azure_pipelist.yml 참고</p>
<p>kubernetes Service</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">trigger</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> master

<span class="token key atrule">resources</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">repo</span><span class="token punctuation">:</span> self

<span class="token key atrule">variables</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> common<span class="token punctuation">-</span>value
  <span class="token comment"># containerRegistry: 'event.azurecr.io'</span>
  <span class="token comment"># containerRegistryDockerConnection: 'acr'</span>
  <span class="token comment"># environment: 'aks.default'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> imageRepository
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'order'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerfilePath
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'**/Dockerfile'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tag
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'$(Build.BuildId)'</span>
  <span class="token comment"># Agent VM image name</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vmImageName
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'ubuntu-latest'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MAVEN_CACHE_FOLDER
  <span class="token key atrule">value</span><span class="token punctuation">:</span> $(Pipeline.Workspace)/.m2/repository
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MAVEN_OPTS
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'</span>


<span class="token key atrule">stages</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">stage</span><span class="token punctuation">:</span> Build
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Build stage
  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job</span><span class="token punctuation">:</span> Build
    <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Build
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">vmImage</span><span class="token punctuation">:</span> $(vmImageName)
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> CacheBeta@1
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">'maven | "$(Agent.OS)" | **/pom.xml'</span>
        <span class="token key atrule">restoreKeys</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
           maven | "$(Agent.OS)"
           maven</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> $(MAVEN_CACHE_FOLDER)
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Cache Maven local repo
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Maven@3
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">mavenPomFile</span><span class="token punctuation">:</span> <span class="token string">'pom.xml'</span>
        <span class="token key atrule">options</span><span class="token punctuation">:</span> <span class="token string">'-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'</span>
        <span class="token key atrule">javaHomeOption</span><span class="token punctuation">:</span> <span class="token string">'JDKVersion'</span>
        <span class="token key atrule">jdkVersionOption</span><span class="token punctuation">:</span> <span class="token string">'1.8'</span>
        <span class="token key atrule">jdkArchitectureOption</span><span class="token punctuation">:</span> <span class="token string">'x64'</span>
        <span class="token key atrule">goals</span><span class="token punctuation">:</span> <span class="token string">'package'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Docker@2
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">containerRegistry</span><span class="token punctuation">:</span> $(containerRegistryDockerConnection)
        <span class="token key atrule">repository</span><span class="token punctuation">:</span> $(imageRepository)
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'buildAndPush'</span>
        <span class="token key atrule">Dockerfile</span><span class="token punctuation">:</span> <span class="token string">'**/Dockerfile'</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          $(tag)</span>

<span class="token punctuation">-</span> <span class="token key atrule">stage</span><span class="token punctuation">:</span> Deploy
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Deploy stage
  <span class="token key atrule">dependsOn</span><span class="token punctuation">:</span> Build

  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">deployment</span><span class="token punctuation">:</span> Deploy
    <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Deploy
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">vmImage</span><span class="token punctuation">:</span> $(vmImageName)
    <span class="token key atrule">environment</span><span class="token punctuation">:</span> $(environment)
    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">runOnce</span><span class="token punctuation">:</span>
        <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
          <span class="token key atrule">steps</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Kubernetes@1
            <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
              <span class="token key atrule">connectionType</span><span class="token punctuation">:</span> <span class="token string">'Kubernetes Service Connection'</span>
              <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">'default'</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'apply'</span>
              <span class="token key atrule">useConfigurationFile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">configurationType</span><span class="token punctuation">:</span> <span class="token string">'inline'</span>
              <span class="token key atrule">inline</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  name: $(imageRepository)
                  labels:
                    app: $(imageRepository)
                spec:
                  replicas: 1
                  selector:
                    matchLabels:
                      app: $(imageRepository)
                  template:
                    metadata:
                      labels:
                        app: $(imageRepository)
                    spec:
                      containers:
                        - name: $(imageRepository)
                          image: $(containerRegistry)/$(imageRepository):$(tag)
                          ports:
                            - containerPort: 8080
                          readinessProbe:
                            httpGet:
                              path: /actuator/health
                              port: 8080
                            initialDelaySeconds: 10
                            timeoutSeconds: 2
                            periodSeconds: 5
                            failureThreshold: 10
                          livenessProbe:
                            httpGet:
                              path: /actuator/health
                              port: 8080
                            initialDelaySeconds: 120
                            timeoutSeconds: 2
                            periodSeconds: 5
                            failureThreshold: 5</span>
              <span class="token key atrule">secretType</span><span class="token punctuation">:</span> <span class="token string">'dockerRegistry'</span>
              <span class="token key atrule">containerRegistryType</span><span class="token punctuation">:</span> <span class="token string">'Azure Container Registry'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Kubernetes@1
            <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
              <span class="token key atrule">connectionType</span><span class="token punctuation">:</span> <span class="token string">'Kubernetes Service Connection'</span>
              <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">'default'</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'apply'</span>
              <span class="token key atrule">useConfigurationFile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">configurationType</span><span class="token punctuation">:</span> <span class="token string">'inline'</span>
              <span class="token key atrule">inline</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
                apiVersion: v1
                kind: Service
                metadata:
                  name: $(imageRepository)
                  labels:
                    app: $(imageRepository)
                spec:
                  ports:
                    - port: 8080
                      targetPort: 8080
                  selector:
                    app: $(imageRepository)</span>
              <span class="token key atrule">secretType</span><span class="token punctuation">:</span> <span class="token string">'dockerRegistry'</span>
              <span class="token key atrule">containerRegistryType</span><span class="token punctuation">:</span> <span class="token string">'Azure Container Registry'</span></code></pre>
<h2 id="동기식-호출--서킷-브레이킹--장애격리"><a href="#%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C--%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%ED%82%B9--%EC%9E%A5%EC%95%A0%EA%B2%A9%EB%A6%AC" aria-hidden="true"><span class="icon icon-link"></span></a>동기식 호출 / 서킷 브레이킹 / 장애격리</h2>
<ul>
<li>서킷 브레이킹 프레임워크의 선택: Spring FeignClient + Hystrix 옵션을 사용하여 구현함</li>
</ul>
<p>시나리오는 예약 시스템(reservation)-->진료(diagnosis) 시의 연결을 RESTful Request/Response 로 연동하여 구현이 되어있고, 진료 요청이 과도할 경우 CB 를 통하여 장애격리.</p>
<ul>
<li>Hystrix 를 설정:  요청처리 쓰레드에서 처리시간이 610 밀리가 넘어서기 시작하여 어느정도 유지되면 CB 회로가 닫히도록 (요청을 빠르게 실패처리, 차단) 설정</li>
</ul>
<pre class="language-text"><code class="language-text"># application.yml

server:
  port: 8081
spring:
  profiles: default
  cloud:
    stream:
      kafka:
        binder:
          brokers: localhost:9092
      bindings:
        output:
          destination: animal
          contentType: application/json
feign:
  hystrix:
    enabled: true
    
    </code></pre>
<ul>
<li>피호출 서비스(진료:diagnosis) 의 임의 부하 처리 - 400 밀리에서 증감 220 밀리 정도 왔다갔다 하게</li>
</ul>
<pre class="language-text"><code class="language-text"># (diagnosis) MedicalRecord.java (Entity)

    @PrePersist
    public void onPrePersist(){  //진료이력을 저장한 후 적당한 시간 끌기
        ...
        
        try {
            Thread.currentThread().sleep((long) (400 + Math.random() * 220));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }</code></pre>
<ul>
<li>부하테스터 siege 툴을 통한 서킷 브레이커 동작 확인:</li>
</ul>
<ul>
<li>동시사용자 100명</li>
<li>60초 동안 실시</li>
</ul>
<pre class="language-text"><code class="language-text">$ siege -c100 -t60s -r10 --content-type &quot;application/json&quot; &#39;http://localhost:8081/reservations POST {&quot;reservatorName&quot;: &quot;Jackson&quot;, &quot;phoneNumber&quot;: &quot;01032713104&quot;, &quot;reservationDate&quot;: &quot;2020-05-01&quot;}&#39;

Windows 안에서 작동하는 Ubuntu에서 siege 실행시 &quot;[error] unable to set close control sock.c:141: Invalid argument&quot; 이 발생하여 중간 과정은 알 수 없음.

그러나 아래와 같은 결과를 확인.

Lifting the server siege...
Transactions:                   1067 hits
Availability:                  78.92 %
Elapsed time:                  59.46 secs
Data transferred:               0.37 MB
Response time:                  5.36 secs
Transaction rate:              17.94 trans/sec
Throughput:                     0.01 MB/sec
Concurrency:                   96.13
Successful transactions:        1067
Failed transactions:             285
Longest transaction:            7.01
Shortest transaction:           0.02</code></pre>
<ul>
<li>운영시스템은 죽지 않고 지속적으로 CB 에 의하여 적절히 회로가 열림과 닫힘이 벌어지면서 자원을 보호하고 있음을 보여줌. 78.92% 가 성공.</li>
</ul>
<h2 id="오토스케일-아웃"><a href="#%EC%98%A4%ED%86%A0%EC%8A%A4%EC%BC%80%EC%9D%BC-%EC%95%84%EC%9B%83" aria-hidden="true"><span class="icon icon-link"></span></a>오토스케일 아웃</h2>
<p>앞서 CB 는 시스템을 안정되게 운영할 수 있게 해줬지만 사용자의 요청을 100% 받아들여주지 못했기 때문에 이에 대한 보완책으로 자동화된 확장 기능을 적용하고자 한다. </p>
<ul>
<li>진료서비스에 대한 replica 를 동적으로 늘려주도록 HPA 를 설정한다. 설정은 CPU 사용량이 15프로를 넘어서면 replica 를 10개까지 늘려준다:</li>
</ul>
<pre class="language-text"><code class="language-text">kubectl autoscale deploy diagnosis --min=1 --max=10 --cpu-percent=15</code></pre>
<h2 id="무정지-재배포"><a href="#%EB%AC%B4%EC%A0%95%EC%A7%80-%EC%9E%AC%EB%B0%B0%ED%8F%AC" aria-hidden="true"><span class="icon icon-link"></span></a>무정지 재배포</h2>
<ul>
<li>모든 프로젝트의 readiness probe 및 liveness probe 설정 완료.</li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /actuator/health
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
     <span class="token key atrule">path</span><span class="token punctuation">:</span> /actuator/health
     <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>
  <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">5</span></code></pre>
</div><div class="mt-8 pt-8 lg:mt-12 lg:pt-12 border-t border-ui-border"><div><div class="flex flex-col sm:flex-row justify-between items-center"><!----><!----></div></div></div></div></div></div></main></div><!----></div>
    <script src="/assets/js/app.06bb65f0.js" defer></script><script src="/assets/js/page--src--templates--markdown-page-vue.7da4a730.js" defer></script>
  </body>
</html>
